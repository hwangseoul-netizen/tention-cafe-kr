import React, {
  useEffect,
  useMemo,
  useRef,
  useState,
} from "react";
import {
  View,
  Text,
  Image,
  ScrollView,
  TouchableOpacity,
  SafeAreaView,
  TextInput,
  PanResponder,
  Dimensions,
  Modal,
  StatusBar,
  Switch,
  Animated,
  Easing,
} from "react-native";

/**
 * VISUMOF v2.0 (K-Beauty Light Theme)
 * - ë‹¨ì¼ App.js / ì™¸ë¶€ ì˜ì¡´ì„± X / TS X
 * - ìƒë‹¨ íƒ­(ê°€ë¡œ ìŠ¤í¬ë¡¤) + í•˜ë‹¨ ì´ëª¨ì§€ ë‚´ë¹„
 * - ì‹œìˆ (í´ë¦¬ë‹‰) ì¹´í…Œê³ ë¦¬ ìµœìš°ì„ 
 * - ì¹´í…Œê³ ë¦¬ë³„ ì¹´ë“œ í…Œë‘ë¦¬ ìƒ‰ìƒ
 * - í”¼ë“œ(ì—…ì²´) / ì»¤ë®¤ë‹ˆí‹°(ì¼ë°˜) / ì—…ë¡œë“œ / ë¹„êµ / íŒŒíŠ¸ë„ˆ / ê°€ì´ë“œ
 */

const { width: SCREEN_W } = Dimensions.get("window");

/* ===== íŒ”ë ˆíŠ¸ (ë¼ì´íŠ¸ K-ë·°í‹° í†¤) ===== */
const PALETTE = {
  bg: "#F7F8FA",
  card: "#FFFFFF",
  line: "#E4E6EC",
  text: "#1E2233",
  sub: "#6D7485",
  brand: "#87D3FF", // ë©”ì¸ íŒŒìŠ¤í…” ë¸”ë£¨
  brandSoft: "#D3F1FF",
  brandMint: "#A6E7C4",
  brandMintSoft: "#E5FAF0",
  ok: "#6AD77B",
  mid: "#79A6F3",
  low: "#B1B1B1",
  chip: "#EFF1F6",
  dim: "#E6E9F0",
  danger: "#F26D6D",
};

/* ===== íƒ­ / ì¹´í…Œê³ ë¦¬ ===== */

const TABS = ["í”¼ë“œ", "ì»¤ë®¤ë‹ˆí‹°", "ì—…ë¡œë“œ", "ë¹„êµ", "íŒŒíŠ¸ë„ˆ", "ê°€ì´ë“œ"];

// ì‹œìˆ (í´ë¦¬ë‹‰) ìµœìš°ì„ 
const CATS = [
  "ì‹œìˆ (í´ë¦¬ë‹‰)",
  "ì „ì²´",
  "ìŠ¤í‚¨ì¼€ì–´",
  "í—¤ì–´",
  "ë°˜ì˜êµ¬",
  "í”¼íŠ¸ë‹ˆìŠ¤",
  "ìì„¸êµì •",
  "ë°”ë””/ë‹¤ì´ì–´íŠ¸",
];

/* ì¹´í…Œê³ ë¦¬ â†’ í…Œë‘ë¦¬ ìƒ‰ìƒ ë§¤í•‘ */
function getCategoryBorderColor(category) {
  if (!category) return PALETTE.line;

  if (category.includes("ì‹œìˆ ")) return "#FFB8C8"; // í•‘í¬
  if (category.includes("ìŠ¤í‚¨ì¼€ì–´")) return "#A4E2FF"; // ìŠ¤ì¹´ì´ë¸”ë£¨
  if (category.includes("í—¤ì–´")) return "#FFE6A7"; // ë¼ì´íŠ¸ ê³¨ë“œ
  if (category.includes("ë°˜ì˜êµ¬")) return "#DDB8FF"; // ë¼ë²¤ë”
  if (category.includes("í”¼íŠ¸ë‹ˆìŠ¤")) return "#C4F7B2"; // ë¼ì´íŠ¸ ê·¸ë¦°
  if (category.includes("ìì„¸êµì •")) return "#D7E5FF"; // í˜ì¼ ë¸”ë£¨
  if (category.includes("ë°”ë””")) return "#FFD6A5"; // ì‚´ëª¬ ì˜¤ë Œì§€

  return PALETTE.line;
}

/* ===== ìƒ˜í”Œ ë°ì´í„° ===== */

const MOCK_FEED = [
  {
    id: "case-001",
    user: "Jade",
    category: "ì‹œìˆ (í´ë¦¬ë‹‰)",
    tags: ["#ì—¬ë“œë¦„í‰í„°", "#ë ˆì´ì €í†¤ì—…", "#í•„í„°ì—†ìŒ"],
    before:
      "https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?q=80&w=1200&auto=format&fit=crop",
    after:
      "https://images.unsplash.com/photo-1522335781184-c34e5b39c1b7?q=80&w=1200&auto=format&fit=crop",
    trust: 92,
    partner: "Glow Clinic",
    location: "Gangnam",
    days: 21,
  },
  {
    id: "case-002",
    user: "Min",
    category: "í—¤ì–´",
    tags: ["#ì»·", "#ë ˆì´ì–´ë“œ", "#ìŠ¤íƒ€ì¼ë§"],
    before:
      "https://images.unsplash.com/photo-1522335781184-5f0b7d5f5b1f?q=80&w=1200&auto=format&fit=crop",
    after:
      "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?q=80&w=1200&auto=format&fit=crop",
    trust: 88,
    partner: "W Hair Studio",
    location: "Hongdae",
    days: 0,
  },
  {
    id: "case-003",
    user: "Sol",
    category: "ë°”ë””/ë‹¤ì´ì–´íŠ¸",
    tags: ["#ì²´ì§€ë°©ê°ì†Œ", "#3ì£¼ë³€í™”", "#ìš´ë™ë³‘í–‰"],
    before:
      "https://images.unsplash.com/photo-1518611012118-696072aa579a?q=80&w=1200&auto=format&fit=crop",
    after:
      "https://images.unsplash.com/photo-1544717305-996b815c338c?q=80&w=1200&auto=format&fit=crop",
    trust: 90,
    partner: "Core PT Lab",
    location: "Seongsu",
    days: 60,
  },
];

const USER_FEED_SAMPLE = [
  {
    id: "u-001",
    user: "Luna",
    desc: "3ì£¼ í™ˆíŠ¸ + ì‹ë‹¨ ë³‘í–‰! ì²´ë ¥ë„ ì˜¤ë¥´ê³  ìì‹ ê°ì´ ìƒê²¼ì–´ìš” ğŸ’ª",
    tags: ["#í™ˆíŠ¸", "#ë‹¤ì´ì–´íŠ¸", "#ìê¸°ê´€ë¦¬"],
    before:
      "https://images.unsplash.com/photo-1518611012118-696072aa579a?q=80&w=1200&auto=format&fit=crop",
    after:
      "https://images.unsplash.com/photo-1544717305-996b815c338c?q=80&w=1200&auto=format&fit=crop",
    likes: 128,
    comments: 12,
    verified: true,
    anonymous: false,
    visibility: "public",
  },
  {
    id: "u-002",
    user: "Neo",
    desc: "ë‘í”¼ ì¼€ì–´ 2ì£¼ì°¨. ë¶‰ì€ê¸°ë‘ ë¹„ë“¬ì´ ì¤„ì—ˆì–´ìš”.",
    tags: ["#ë‘í”¼ì¼€ì–´", "#ëª¨ë°œ", "#2ì£¼ì°¨"],
    before:
      "https://images.unsplash.com/photo-1519415943484-9fa18778ef04?q=80&w=1200&auto=format&fit=crop",
    after:
      "https://images.unsplash.com/photo-1495461199391-8c39f6db9a47?q=80&w=1200&auto=format&fit=crop",
    likes: 67,
    comments: 5,
    verified: false,
    anonymous: true,
    visibility: "public",
  },
];

const PARTNERS = [
  {
    id: "p-01",
    name: "Glow Clinic",
    field: "í”¼ë¶€ê³¼ Â· ì‹œìˆ (í´ë¦¬ë‹‰)",
    badge: "Verified",
    addr: "ì„œìš¸ ê°•ë‚¨êµ¬",
    phone: "02-000-0000",
  },
  {
    id: "p-02",
    name: "W Hair Studio",
    field: "í—¤ì–´ì‚´ë¡±",
    badge: "Pro",
    addr: "ì„œìš¸ ë§ˆí¬êµ¬",
    phone: "02-111-1111",
  },
  {
    id: "p-03",
    name: "Core PT Lab",
    field: "PT/ì²´í˜•êµì • Â· ë°”ë””/ë‹¤ì´ì–´íŠ¸",
    badge: "Pro",
    addr: "ì„œìš¸ ì„±ë™êµ¬",
    phone: "02-222-2222",
  },
];

/* ===== ê³µí†µ ì»´í¬ë„ŒíŠ¸ ===== */

function SectionTitle({ children, right }) {
  return (
    <View
      style={{
        flexDirection: "row",
        justifyContent: "space-between",
        alignItems: "center",
        marginBottom: 10,
      }}
    >
      <Text
        style={{
          color: PALETTE.text,
          fontSize: 18,
          fontWeight: "800",
        }}
      >
        {children}
      </Text>
      {right}
    </View>
  );
}

function Card({ children, style, accent }) {
  const borderColor = accent || PALETTE.line;
  const bgTint = accent
    ? {
        backgroundColor: "#FFFFFF",
        shadowColor: accent,
        shadowOpacity: 0.12,
        shadowRadius: 8,
        shadowOffset: { width: 0, height: 3 },
        elevation: 2,
      }
    : {
        backgroundColor: PALETTE.card,
        shadowColor: "#000",
        shadowOpacity: 0.03,
        shadowRadius: 4,
        shadowOffset: { width: 0, height: 2 },
        elevation: 1,
      };

  return (
    <View
      style={[
        {
          borderRadius: 14,
          padding: 12,
          borderWidth: 1,
          borderColor,
        },
        bgTint,
        style,
      ]}
    >
      {children}
    </View>
  );
}

function Chip({ label, active, onPress }) {
  return (
    <TouchableOpacity
      onPress={onPress}
      style={{
        backgroundColor: active ? PALETTE.brand : PALETTE.chip,
        paddingHorizontal: 12,
        paddingVertical: 8,
        borderRadius: 999,
        marginRight: 8,
        marginBottom: 8,
        borderWidth: active ? 0 : 1,
        borderColor: PALETTE.line,
      }}
    >
      <Text
        style={{
          color: active ? "#0A1020" : PALETTE.sub,
          fontWeight: "700",
        }}
      >
        {label}
      </Text>
    </TouchableOpacity>
  );
}

function TrustBadge({ value }) {
  const tone =
    value >= 90 ? PALETTE.ok : value >= 80 ? PALETTE.mid : PALETTE.low;
  const label =
    value >= 90 ? "High" : value >= 80 ? "Mid" : "Basic";

  return (
    <View
      style={{
        flexDirection: "row",
        alignItems: "center",
        backgroundColor: tone,
        paddingHorizontal: 10,
        paddingVertical: 6,
        borderRadius: 999,
      }}
    >
      <Text
        style={{
          color: "#fff",
          fontWeight: "700",
          fontSize: 11,
        }}
      >
        ì‹ ë¢° {value} Â· {label}
      </Text>
    </View>
  );
}

function CommunityBadge({ verified }) {
  return (
    <View
      style={{
        backgroundColor: verified ? PALETTE.ok : PALETTE.mid,
        paddingHorizontal: 8,
        paddingVertical: 4,
        borderRadius: 999,
      }}
    >
      <Text
        style={{
          color: "#fff",
          fontWeight: "800",
          fontSize: 11,
        }}
      >
        {verified ? "í•„í„° ê°ì§€ ì—†ìŒ" : "ê²€ì¦ ëŒ€ê¸°"}
      </Text>
    </View>
  );
}

/* ===== ì´ë¯¸ì§€ ë¡œë”© í”Œë ˆì´ìŠ¤í™€ë” ===== */

function Img({ uri, style, radius = 10 }) {
  const [ok, setOk] = useState(false);
  const opacity = useRef(new Animated.Value(0.4)).current;

  useEffect(() => {
    if (!ok) {
      const loop = Animated.loop(
        Animated.sequence([
          Animated.timing(opacity, {
            toValue: 0.9,
            duration: 700,
            easing: Easing.inOut(Easing.quad),
            useNativeDriver: true,
          }),
          Animated.timing(opacity, {
            toValue: 0.4,
            duration: 700,
            easing: Easing.inOut(Easing.quad),
            useNativeDriver: true,
          }),
        ])
      );
      loop.start();
      return () => loop.stop();
    }
  }, [ok, opacity]);

  return (
    <View
      style={[
        {
          borderRadius: radius,
          overflow: "hidden",
          backgroundColor: "#EDF1F7",
        },
        style,
      ]}
    >
      {!ok && (
        <Animated.View
          style={{
            position: "absolute",
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            opacity,
            backgroundColor: "#E1E7F5",
          }}
        />
      )}
      <Image
        source={{ uri }}
        style={[{ width: "100%", height: "100%" }, style]}
        onLoad={() => setOk(true)}
      />
    </View>
  );
}

/* ===== Before / After ìŠ¬ë¼ì´ë” ===== */

function BeforeAfterSlider({ before, after, height = 260, radius = 18 }) {
  const screenW = SCREEN_W - 24;
  const [x, setX] = useState(screenW * 0.5);
  const startX = useRef(x);

  const pan = useRef(
    PanResponder.create({
      onStartShouldSetPanResponder: () => true,
      onMoveShouldSetPanResponder: () => true,
      onPanResponderGrant: () => {
        startX.current = x;
      },
      onPanResponderMove: (_, g) => {
        const nx = Math.max(0, Math.min(screenW, startX.current + g.dx));
        setX(nx);
      },
    })
  ).current;

  return (
    <View
      style={{
        width: screenW,
        height,
        borderRadius: radius,
        overflow: "hidden",
        alignSelf: "center",
        backgroundColor: "#000",
      }}
    >
      <Image
        source={{ uri: before }}
        style={{
          position: "absolute",
          width: screenW,
          height,
          resizeMode: "cover",
        }}
      />
      <View
        style={{
          position: "absolute",
          width: x,
          height,
          overflow: "hidden",
        }}
      >
        <Image
          source={{ uri: after }}
          style={{ width: screenW, height, resizeMode: "cover" }}
        />
      </View>

      <View
        {...pan.panHandlers}
        style={{
          position: "absolute",
          left: x - 16,
          top: 0,
          width: 32,
          height,
          alignItems: "center",
          justifyContent: "center",
        }}
      >
        <View
          style={{
            width: 2,
            height,
            backgroundColor: "rgba(255,255,255,0.9)",
          }}
        />
        <View
          style={{
            position: "absolute",
            top: height / 2 - 18,
            width: 40,
            height: 40,
            borderRadius: 999,
            backgroundColor: "rgba(0,0,0,0.4)",
            borderWidth: 1,
            borderColor: "rgba(255,255,255,0.7)",
            alignItems: "center",
            justifyContent: "center",
          }}
        >
          <Text style={{ color: "#fff", fontWeight: "900" }}>â‡†</Text>
        </View>
      </View>

      <View
        style={{
          position: "absolute",
          top: 8,
          left: 8,
          backgroundColor: "rgba(0,0,0,0.45)",
          paddingHorizontal: 8,
          paddingVertical: 4,
          borderRadius: 6,
        }}
      >
        <Text style={{ color: "#fff", fontSize: 12 }}>Before</Text>
      </View>
      <View
        style={{
          position: "absolute",
          top: 8,
          right: 8,
          backgroundColor: "rgba(0,0,0,0.45)",
          paddingHorizontal: 8,
          paddingVertical: 4,
          borderRadius: 6,
        }}
      >
        <Text style={{ color: "#fff", fontSize: 12 }}>After</Text>
      </View>
    </View>
  );
}

/* ===== í—¤ë” / ë‚´ë¹„ ===== */

function Header({ tab, setTab }) {
  return (
    <View
      style={{
        paddingHorizontal: 12,
        paddingTop: 10,
        paddingBottom: 10,
        backgroundColor: "rgba(247,248,250,0.96)",
        borderBottomWidth: 1,
        borderColor: PALETTE.line,
      }}
    >
      <View
        style={{
          flexDirection: "row",
          alignItems: "center",
          justifyContent: "space-between",
          marginBottom: 10,
        }}
      >
        <Text
          style={{
            color: PALETTE.text,
            fontWeight: "900",
            fontSize: 22,
          }}
        >
          VISUMOF
        </Text>
        <View
          style={{
            flexDirection: "row",
            alignItems: "center",
            gap: 8,
          }}
        >
          <View
            style={{
              backgroundColor: PALETTE.brandSoft,
              paddingHorizontal: 10,
              paddingVertical: 6,
              borderRadius: 999,
            }}
          >
            <Text
              style={{ color: "#1C2A3E", fontSize: 11, fontWeight: "700" }}
            >
              K-Beauty
            </Text>
          </View>
          <View
            style={{
              backgroundColor: PALETTE.chip,
              paddingHorizontal: 10,
              paddingVertical: 6,
              borderRadius: 999,
            }}
          >
            <Text
              style={{ color: PALETTE.sub, fontSize: 11 }}
            >
              â€œì „í›„ì‚¬ì§„ì´ ê³§ ì–¸ì–´ë‹¤â€
            </Text>
          </View>
        </View>
      </View>

      {/* ìƒë‹¨ íƒ­: ê°€ë¡œ ìŠ¤í¬ë¡¤ í•œ ì¤„ ë°°ì¹˜ â†’ ë” ì´ìƒ ì•„ë˜ë¡œ ì•ˆ ì‚ì ¸ë‚˜ì˜´ */}
      <ScrollView
        horizontal
        showsHorizontalScrollIndicator={false}
        contentContainerStyle={{ paddingVertical: 2 }}
      >
        <View style={{ flexDirection: "row" }}>
          {TABS.map((t) => {
            const active = tab === t;
            return (
              <TouchableOpacity
                key={t}
                onPress={() => setTab(t)}
                style={{
                  paddingHorizontal: 12,
                  paddingVertical: 8,
                  borderRadius: 999,
                  marginRight: 8,
                  backgroundColor: active
                    ? PALETTE.brand
                    : "transparent",
                  borderWidth: active ? 0 : 1,
                  borderColor: PALETTE.line,
                }}
              >
                <Text
                  style={{
                    color: active ? "#0A1020" : PALETTE.text,
                    fontWeight: "800",
                    fontSize: 13,
                  }}
                >
                  {t}
                </Text>
              </TouchableOpacity>
            );
          })}
        </View>
      </ScrollView>
    </View>
  );
}

function NavBar({ tab, setTab }) {
  const icons = {
    í”¼ë“œ: "ğŸ ",
    ì»¤ë®¤ë‹ˆí‹°: "ğŸ‘¥",
    ì—…ë¡œë“œ: "ğŸ“¤",
    ë¹„êµ: "ğŸª",
    íŒŒíŠ¸ë„ˆ: "ğŸ·ï¸",
    ê°€ì´ë“œ: "ğŸ“˜",
  };

  return (
    <View
      style={{
        paddingHorizontal: 12,
        paddingBottom: 10,
        paddingTop: 6,
      }}
    >
      <View
        style={{
          backgroundColor: "#FFFFFF",
          borderRadius: 18,
          borderWidth: 1,
          borderColor: PALETTE.line,
          flexDirection: "row",
          justifyContent: "space-around",
          paddingVertical: 8,
          shadowColor: "#000",
          shadowOpacity: 0.06,
          shadowRadius: 6,
          shadowOffset: { width: 0, height: 2 },
          elevation: 2,
        }}
      >
        {TABS.map((t) => {
          const active = tab === t;
          return (
            <TouchableOpacity
              key={t}
              onPress={() => setTab(t)}
              style={{
                paddingHorizontal: 10,
                paddingVertical: 6,
                borderRadius: 999,
                backgroundColor: active
                  ? PALETTE.brandMint
                  : "transparent",
              }}
            >
              <Text
                style={{
                  color: active ? "#0A1020" : PALETTE.text,
                  fontWeight: "800",
                  fontSize: 13,
                }}
              >
                {icons[t]} {t}
              </Text>
            </TouchableOpacity>
          );
        })}
      </View>
    </View>
  );
}

/* ===== í”¼ë“œ (ì—…ì²´) ===== */

function FeedItem({
  item,
  onCompare,
  showAfter,
  onToggle,
}) {
  const accent = getCategoryBorderColor(item.category);

  return (
    <Card style={{ marginBottom: 14 }} accent={accent}>
      <View
        style={{
          flexDirection: "row",
          alignItems: "center",
          marginBottom: 10,
        }}
      >
        <View
          style={{
            width: 36,
            height: 36,
            borderRadius: 18,
            backgroundColor: PALETTE.chip,
            justifyContent: "center",
            alignItems: "center",
            marginRight: 10,
          }}
        >
          <Text
            style={{
              color: PALETTE.text,
              fontWeight: "700",
            }}
          >
            {item.user[0]}
          </Text>
        </View>
        <View style={{ flex: 1 }}>
          <Text
            style={{
              color: PALETTE.text,
              fontWeight: "700",
            }}
          >
            {item.user}
          </Text>
          <Text
            style={{
              color: PALETTE.sub,
              fontSize: 12,
            }}
          >
            {item.category} Â· {item.location}
          </Text>
        </View>
        <TrustBadge value={item.trust} />
      </View>

      <Img
        uri={showAfter ? item.after : item.before}
        style={{
          width: SCREEN_W - 48,
          height: 200,
          borderRadius: 14,
        }}
        radius={14}
      />

      <View
        style={{
          flexDirection: "row",
          flexWrap: "wrap",
          marginTop: 10,
        }}
      >
        {item.tags.map((t) => (
          <View
            key={t}
            style={{
              backgroundColor: PALETTE.chip,
              paddingHorizontal: 10,
              paddingVertical: 6,
              borderRadius: 999,
              marginRight: 8,
              marginBottom: 8,
            }}
          >
            <Text
              style={{ color: PALETTE.sub, fontSize: 12 }}
            >
              {t}
            </Text>
          </View>
        ))}
      </View>

      <View
        style={{
          flexDirection: "row",
          marginTop: 10,
          alignItems: "center",
        }}
      >
        <TouchableOpacity
          onPress={() => onToggle(item.id)}
          style={{
            backgroundColor: PALETTE.chip,
            paddingHorizontal: 12,
            paddingVertical: 8,
            borderRadius: 10,
            marginRight: 8,
          }}
        >
          <Text
            style={{
              color: PALETTE.text,
              fontWeight: "800",
            }}
          >
            {showAfter ? "Before ë³´ê¸°" : "After ë³´ê¸°"}
          </Text>
        </TouchableOpacity>
        <TouchableOpacity
          onPress={() => onCompare(item)}
          style={{
            backgroundColor: PALETTE.brand,
            paddingHorizontal: 12,
            paddingVertical: 8,
            borderRadius: 10,
            marginRight: 8,
          }}
        >
          <Text
            style={{
              color: "#0A1020",
              fontWeight: "800",
            }}
          >
            ìŠ¬ë¼ì´ë”ë¡œ ë¹„êµ
          </Text>
        </TouchableOpacity>
        <TouchableOpacity
          style={{
            backgroundColor: PALETTE.brandMint,
            paddingHorizontal: 12,
            paddingVertical: 8,
            borderRadius: 10,
          }}
        >
          <Text
            style={{
              color: "#0A1020",
              fontWeight: "800",
            }}
          >
            ì €ì¥
          </Text>
        </TouchableOpacity>
      </View>
    </Card>
  );
}

function FeedTab({
  onCompare,
  cat,
  setCat,
  q,
  setQ,
  sort,
  setSort,
  itemToggles,
  setItemToggles,
}) {
  const filtered = useMemo(() => {
    let arr = MOCK_FEED.filter((f) =>
      cat === "ì „ì²´" ? true : f.category === cat
    );

    if (q) {
      const qq = q.toLowerCase();
      arr = arr.filter((f) =>
        (
          f.user +
          f.category +
          f.partner +
          f.tags.join(" ")
        )
          .toLowerCase()
          .includes(qq)
      );
    }

    if (sort === "ì‹ ë¢°ìˆœ") {
      arr = arr.slice().sort((a, b) => b.trust - a.trust);
    }
    if (sort === "ìµœì‹ ìˆœ") {
      arr = arr.slice().sort((a, b) => b.days - a.days);
    }

    return arr;
  }, [cat, q, sort]);

  const toggle = (id) => {
    setItemToggles({
      ...itemToggles,
      [id]: !itemToggles[id],
    });
  };

  return (
    <ScrollView
      style={{ padding: 12 }}
      showsVerticalScrollIndicator={false}
    >
      <SectionTitle
        right={
          <View style={{ flexDirection: "row" }}>
            {["ì‹ ë¢°ìˆœ", "ìµœì‹ ìˆœ"].map((s) => {
              const active = sort === s;
              return (
                <TouchableOpacity
                  key={s}
                  onPress={() => setSort(s)}
                  style={{
                    paddingHorizontal: 10,
                    paddingVertical: 6,
                    borderRadius: 999,
                    backgroundColor: active
                      ? PALETTE.brand
                      : "transparent",
                    borderWidth: 1,
                    borderColor: active
                      ? "transparent"
                      : PALETTE.line,
                    marginLeft: 8,
                  }}
                >
                  <Text
                    style={{
                      color: active
                        ? "#0A1020"
                        : PALETTE.sub,
                      fontWeight: "800",
                      fontSize: 11,
                    }}
                  >
                    {s}
                  </Text>
                </TouchableOpacity>
              );
            })}
          </View>
        }
      >
        ì—…ì²´ ì „í›„
      </SectionTitle>

      {/* ê²€ìƒ‰ */}
      <View
        style={{
          flexDirection: "row",
          alignItems: "center",
          backgroundColor: PALETTE.card,
          borderRadius: 12,
          borderWidth: 1,
          borderColor: PALETTE.line,
          marginBottom: 12,
        }}
      >
        <Text
          style={{
            color: PALETTE.sub,
            paddingLeft: 12,
            paddingRight: 6,
          }}
        >
          ğŸ”
        </Text>
        <TextInput
          value={q}
          onChangeText={setQ}
          placeholder="ì‹œìˆ /ìƒµ/í•´ì‹œíƒœê·¸ ê²€ìƒ‰"
          placeholderTextColor="#ADB4C5"
          style={{
            flex: 1,
            color: PALETTE.text,
            paddingVertical: 10,
            paddingRight: 12,
          }}
        />
      </View>

      {/* ì¹´í…Œê³ ë¦¬ í•„í„° */}
      <ScrollView
        horizontal
        showsHorizontalScrollIndicator={false}
        style={{ marginBottom: 12 }}
      >
        <View style={{ flexDirection: "row" }}>
          {CATS.map((c) => (
            <Chip
              key={c}
              label={c}
              active={cat === c}
              onPress={() => setCat(c)}
            />
          ))}
        </View>
      </ScrollView>

      {/* ë¦¬ìŠ¤íŠ¸ */}
      {filtered.map((item) => (
        <FeedItem
          key={item.id}
          item={item}
          onCompare={onCompare}
          showAfter={!!itemToggles[item.id]}
          onToggle={toggle}
        />
      ))}
      {filtered.length === 0 && (
        <Card>
          <Text style={{ color: PALETTE.sub }}>
            ì¡°ê±´ì— ë§ëŠ” ì „í›„ê°€ ì—†ì–´ìš”. í•„í„°ë¥¼ ë°”ê¿”ë³´ì!
          </Text>
        </Card>
      )}

      <View style={{ height: 80 }} />
    </ScrollView>
  );
}

/* ===== ì»¤ë®¤ë‹ˆí‹° ===== */

function CommunityItem({
  item,
  onCompare,
  onLike,
  onReport,
}) {
  return (
    <Card style={{ marginBottom: 14 }}>
      <View
        style={{
          flexDirection: "row",
          alignItems: "center",
          marginBottom: 8,
        }}
      >
        <View
          style={{
            width: 34,
            height: 34,
            borderRadius: 17,
            backgroundColor: PALETTE.chip,
            justifyContent: "center",
            alignItems: "center",
            marginRight: 10,
          }}
        >
          <Text
            style={{
              color: PALETTE.text,
              fontWeight: "800",
            }}
          >
            {item.anonymous ? "?" : item.user[0]}
          </Text>
        </View>
        <View style={{ flex: 1 }}>
          <Text
            style={{
              color: PALETTE.text,
              fontWeight: "800",
            }}
          >
            {item.anonymous ? "ìµëª…" : item.user}
          </Text>
          <Text
            style={{
              color: PALETTE.sub,
              fontSize: 12,
            }}
          >
            {item.visibility === "public"
              ? "ì „ì²´ê³µê°œ"
              : item.visibility}
          </Text>
        </View>
        <CommunityBadge verified={item.verified} />
      </View>

      {item.desc ? (
        <Text
          style={{
            color: PALETTE.text,
            marginBottom: 8,
          }}
        >
          {item.desc}
        </Text>
      ) : null}

      <View style={{ flexDirection: "row" }}>
        <Img
          uri={item.before}
          style={{
            width: (SCREEN_W - 48) / 2,
            height: 160,
            borderRadius: 10,
            marginRight: 8,
          }}
        />
        <Img
          uri={item.after}
          style={{
            width: (SCREEN_W - 48) / 2,
            height: 160,
            borderRadius: 10,
          }}
        />
      </View>

      <View
        style={{
          flexDirection: "row",
          flexWrap: "wrap",
          marginTop: 8,
        }}
      >
        {item.tags.map((t) => (
          <View
            key={t}
            style={{
              backgroundColor: PALETTE.chip,
              paddingHorizontal: 10,
              paddingVertical: 6,
              borderRadius: 999,
              marginRight: 8,
              marginBottom: 8,
            }}
          >
            <Text
              style={{ color: PALETTE.sub, fontSize: 12 }}
            >
              {t}
            </Text>
          </View>
        ))}
      </View>

      <View
        style={{
          flexDirection: "row",
          justifyContent: "space-between",
          marginTop: 8,
          alignItems: "center",
        }}
      >
        <View
          style={{
            flexDirection: "row",
            alignItems: "center",
          }}
        >
          <TouchableOpacity
            onPress={onLike}
            style={{ marginRight: 14 }}
          >
            <Text
              style={{ color: PALETTE.sub, fontSize: 13 }}
            >
              â¤ï¸ {item.likes}
            </Text>
          </TouchableOpacity>
          <Text
            style={{ color: PALETTE.sub, fontSize: 13 }}
          >
            ğŸ’¬ {item.comments}
          </Text>
        </View>

        <View style={{ flexDirection: "row" }}>
          <TouchableOpacity
            onPress={() => onCompare(item)}
            style={{
              backgroundColor: PALETTE.brand,
              paddingHorizontal: 10,
              paddingVertical: 6,
              borderRadius: 8,
              marginRight: 8,
            }}
          >
            <Text
              style={{
                color: "#0A1020",
                fontWeight: "800",
                fontSize: 12,
              }}
            >
              ìŠ¬ë¼ì´ë”ë¡œ ë¹„êµ
            </Text>
          </TouchableOpacity>
          <TouchableOpacity
            onPress={onReport}
            style={{
              backgroundColor: PALETTE.danger,
              paddingHorizontal: 10,
              paddingVertical: 6,
              borderRadius: 8,
            }}
          >
            <Text
              style={{
                color: "#fff",
                fontWeight: "800",
                fontSize: 12,
              }}
            >
              ì‹ ê³ 
            </Text>
          </TouchableOpacity>
        </View>
      </View>
    </Card>
  );
}

function CommunityTab({
  userFeed,
  setUserFeed,
  onCompare,
  onToast,
}) {
  return (
    <ScrollView
      style={{ padding: 12 }}
      showsVerticalScrollIndicator={false}
    >
      <SectionTitle>ì¼ë°˜ ì „í›„ ì»¤ë®¤ë‹ˆí‹°</SectionTitle>

      {userFeed.map((item, idx) => (
        <CommunityItem
          key={item.id}
          item={item}
          onCompare={onCompare}
          onLike={() => {
            const arr = [...userFeed];
            arr[idx] = {
              ...arr[idx],
              likes: arr[idx].likes + 1,
            };
            setUserFeed(arr);
          }}
          onReport={() =>
            onToast(
              "ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆì–´. ê²€í†  í›„ ì¡°ì¹˜í• ê²Œ."
            )
          }
        />
      ))}

      {userFeed.length === 0 && (
        <Card>
          <Text style={{ color: PALETTE.sub }}>
            ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ì–´. ë„¤ ì „í›„ë¥¼ ì²« ë²ˆì§¸ë¡œ ì˜¬ë ¤ë´!
          </Text>
        </Card>
      )}

      <View style={{ height: 80 }} />
    </ScrollView>
  );
}

/* ===== ë¹„êµ íƒ­ ===== */

function CompareTab({ payload }) {
  const current = payload || MOCK_FEED[0];

  return (
    <ScrollView
      style={{ padding: 12 }}
      showsVerticalScrollIndicator={false}
    >
      <SectionTitle>ìŠ¬ë¼ì´ë” ë¹„êµ</SectionTitle>

      <BeforeAfterSlider
        before={current.before}
        after={current.after}
      />

      <View style={{ height: 12 }} />

      <Card>
        {"partner" in current ? (
          <>
            <Text
              style={{
                color: PALETTE.text,
                fontWeight: "800",
                marginBottom: 6,
              }}
            >
              {current.user} Â· {current.category}
            </Text>
            <Text
              style={{
                color: PALETTE.sub,
                marginBottom: 6,
              }}
            >
              {current.partner} Â· {current.location}
            </Text>
          </>
        ) : (
          <>
            <Text
              style={{
                color: PALETTE.text,
                fontWeight: "800",
                marginBottom: 6,
              }}
            >
              {current.anonymous ? "ìµëª…" : current.user} Â·
              Personal
            </Text>
            <Text
              style={{
                color: PALETTE.sub,
                marginBottom: 6,
              }}
            >
              ì¼ë°˜ ì „í›„ Â· {current.visibility}
            </Text>
            {current.desc ? (
              <Text style={{ color: PALETTE.text }}>
                {current.desc}
              </Text>
            ) : null}
          </>
        )}
      </Card>

      <View style={{ height: 80 }} />
    </ScrollView>
  );
}

/* ===== ì—…ë¡œë“œ íƒ­ ===== */

function UploadGuideCard() {
  const GUIDE = [
    "ì •ë©´Â·45ë„Â·ì¸¡ë©´ 3ì»·(ê°€ëŠ¥í•˜ë©´ ì‚¼ê°ëŒ€ ì‚¬ìš©)",
    "ë°ì€ ìì—°ê´‘ / ë™ì¼ ì¡°ëª… ìœ ì§€",
    "ë¨¸ë¦¬Â·ì–´ê¹¨Â·ì¹´ë©”ë¼ ê±°ë¦¬ ë™ì¼",
    "í•„í„°Â·ë³´ì • OFF (ì›ë³¸ ê¶Œì¥)",
    "ë°°ê²½ ë‹¨ìƒ‰ / ê·¸ë¦¼ì ìµœì†Œí™”",
  ];

  return (
    <Card>
      <SectionTitle>ì´¬ì˜ ê°€ì´ë“œ</SectionTitle>

      {GUIDE.map((t, i) => (
        <View
          key={i}
          style={{
            flexDirection: "row",
            alignItems: "center",
            marginBottom: 8,
          }}
        >
          <View
            style={{
              width: 8,
              height: 8,
              borderRadius: 4,
              backgroundColor: PALETTE.brand,
              marginRight: 10,
            }}
          />
          <Text style={{ color: PALETTE.text }}>{t}</Text>
        </View>
      ))}

      <View
        style={{
          marginTop: 10,
          backgroundColor: PALETTE.brandMintSoft,
          padding: 12,
          borderRadius: 12,
        }}
      >
        <Text
          style={{ color: PALETTE.sub, fontSize: 12 }}
        >
          * ë°ëª¨ëŠ” ì´ë¯¸ì§€ URL ë¶™ì—¬ë„£ê¸° ë°©ì‹. ì •ì‹ ë°°í¬ ì‹œ
          ê°¤ëŸ¬ë¦¬/ì¹´ë©”ë¼ ì—°ë™ ì˜ˆì •.
        </Text>
      </View>
    </Card>
  );
}

function UploadTab({
  onSubmit,
  openTerms,
  lastModeRef,
}) {
  const [mode, setMode] = useState(
    lastModeRef.current || "user"
  ); // "user" | "partner"

  useEffect(() => {
    lastModeRef.current = mode;
  }, [mode, lastModeRef]);

  const [title, setTitle] = useState("");
  const [beforeUrl, setBeforeUrl] = useState("");
  const [afterUrl, setAfterUrl] = useState("");
  const [tags, setTags] = useState("");

  const [emotion, setEmotion] = useState("");
  const [anonymous, setAnonymous] = useState(false);
  const [visibility, setVisibility] =
    useState("public");

  const [partnerName, setPartnerName] =
    useState("");
  const [partnerCategory, setPartnerCategory] =
    useState("ì‹œìˆ (í´ë¦¬ë‹‰)");

  const [consent, setConsent] = useState(false);

  const canSubmit =
    title &&
    beforeUrl &&
    afterUrl &&
    consent &&
    (mode === "user"
      ? true
      : partnerName && partnerCategory);

  return (
    <ScrollView
      style={{ padding: 12 }}
      showsVerticalScrollIndicator={false}
    >
      <SectionTitle
        right={
          <View style={{ flexDirection: "row" }}>
            {["user", "partner"].map((m) => {
              const active = mode === m;
              return (
                <TouchableOpacity
                  key={m}
                  onPress={() => setMode(m)}
                  style={{
                    paddingHorizontal: 10,
                    paddingVertical: 6,
                    borderRadius: 999,
                    backgroundColor: active
                      ? PALETTE.brand
                      : "transparent",
                    borderWidth: 1,
                    borderColor: active
                      ? "transparent"
                      : PALETTE.line,
                    marginLeft: 8,
                  }}
                >
                  <Text
                    style={{
                      color: active
                        ? "#0A1020"
                        : PALETTE.sub,
                      fontWeight: "800",
                      fontSize: 12,
                    }}
                  >
                    {m === "user" ? "ì¼ë°˜" : "ì—…ì²´"}
                  </Text>
                </TouchableOpacity>
              );
            })}
          </View>
        }
      >
        ë‚´ ì „í›„ ì—…ë¡œë“œ
      </SectionTitle>

      <Card>
        <Text
          style={{
            color: PALETTE.sub,
            marginBottom: 6,
          }}
        >
          ì œëª©
        </Text>
        <TextInput
          value={title}
          onChangeText={setTitle}
          placeholder={
            mode === "user"
              ? "ì˜ˆ) 3ì£¼ì°¨ í™ˆíŠ¸ ë³€í™”!"
              : "ì˜ˆ) ì—¬ë“œë¦„ ìŠ¤í‚¨ì¼€ì–´ í”„ë¡œê·¸ë¨"
          }
          placeholderTextColor="#A3ACBF"
          style={{
            backgroundColor: "#F3F5FA",
            color: PALETTE.text,
            borderRadius: 10,
            paddingHorizontal: 12,
            paddingVertical: 10,
            marginBottom: 10,
          }}
        />

        <Text
          style={{
            color: PALETTE.sub,
            marginBottom: 6,
          }}
        >
          Before ì´ë¯¸ì§€ URL
        </Text>
        <TextInput
          value={beforeUrl}
          onChangeText={setBeforeUrl}
          placeholder="https:// ... before.jpg"
          placeholderTextColor="#A3ACBF"
          style={{
            backgroundColor: "#F3F5FA",
            color: PALETTE.text,
            borderRadius: 10,
            paddingHorizontal: 12,
            paddingVertical: 10,
            marginBottom: 10,
          }}
        />

        <Text
          style={{
            color: PALETTE.sub,
            marginBottom: 6,
          }}
        >
          After ì´ë¯¸ì§€ URL
        </Text>
        <TextInput
          value={afterUrl}
          onChangeText={setAfterUrl}
          placeholder="https:// ... after.jpg"
          placeholderTextColor="#A3ACBF"
          style={{
            backgroundColor: "#F3F5FA",
            color: PALETTE.text,
            borderRadius: 10,
            paddingHorizontal: 12,
            paddingVertical: 10,
            marginBottom: 10,
          }}
        />

        <Text
          style={{
            color: PALETTE.sub,
            marginBottom: 6,
          }}
        >
          í•´ì‹œíƒœê·¸(ê³µë°± êµ¬ë¶„)
        </Text>
        <TextInput
          value={tags}
          onChangeText={setTags}
          placeholder="#í™ˆíŠ¸ #ë‹¤ì´ì–´íŠ¸ #í”¼ë¶€"
          placeholderTextColor="#A3ACBF"
          style={{
            backgroundColor: "#F3F5FA",
            color: PALETTE.text,
            borderRadius: 10,
            paddingHorizontal: 12,
            paddingVertical: 10,
            marginBottom: 10,
          }}
        />

        {mode === "user" ? (
          <>
            <Text
              style={{
                color: PALETTE.sub,
                marginBottom: 6,
              }}
            >
              ê°ì • ë¡œê·¸(ì„ íƒ)
            </Text>
            <TextInput
              value={emotion}
              onChangeText={setEmotion}
              placeholder="ì˜ˆ) ìŠ¤ìŠ¤ë¡œë„ ë†€ëì–´ìš”! ìì‹ ê°ì´ ìƒê²¼ì–´ìš” ğŸ˜Š"
              placeholderTextColor="#A3ACBF"
              style={{
                backgroundColor: "#F3F5FA",
                color: PALETTE.text,
                borderRadius: 10,
                paddingHorizontal: 12,
                paddingVertical: 10,
                marginBottom: 10,
              }}
            />

            <View
              style={{
                flexDirection: "row",
                alignItems: "center",
                marginBottom: 8,
              }}
            >
              <Switch
                value={anonymous}
                onValueChange={setAnonymous}
              />
              <Text
                style={{
                  color: PALETTE.text,
                  marginLeft: 8,
                }}
              >
                ìµëª…ìœ¼ë¡œ ì˜¬ë¦¬ê¸°
              </Text>
            </View>

            <View
              style={{
                flexDirection: "row",
                marginBottom: 10,
              }}
            >
              {[
                { k: "public", n: "ì „ì²´ê³µê°œ" },
                { k: "followers", n: "íŒ”ë¡œì›Œ" },
                { k: "private", n: "ë¹„ê³µê°œ" },
              ].map((v) => {
                const active = visibility === v.k;
                return (
                  <TouchableOpacity
                    key={v.k}
                    onPress={() =>
                      setVisibility(v.k)
                    }
                    style={{
                      paddingHorizontal: 10,
                      paddingVertical: 6,
                      borderRadius: 999,
                      backgroundColor: active
                        ? PALETTE.brandMint
                        : PALETTE.chip,
                      marginRight: 8,
                    }}
                  >
                    <Text
                      style={{
                        color: active
                          ? "#0A1020"
                          : PALETTE.text,
                        fontWeight: "800",
                        fontSize: 12,
                      }}
                    >
                      {v.n}
                    </Text>
                  </TouchableOpacity>
                );
              })}
            </View>
          </>
        ) : (
          <>
            <Text
              style={{
                color: PALETTE.sub,
                marginBottom: 6,
              }}
            >
              ì—…ì²´ëª…
            </Text>
            <TextInput
              value={partnerName}
              onChangeText={setPartnerName}
              placeholder="ì˜ˆ) VISUMOF Clinic"
              placeholderTextColor="#A3ACBF"
              style={{
                backgroundColor: "#F3F5FA",
                color: PALETTE.text,
                borderRadius: 10,
                paddingHorizontal: 12,
                paddingVertical: 10,
                marginBottom: 10,
              }}
            />

            <Text
              style={{
                color: PALETTE.sub,
                marginBottom: 6,
              }}
            >
              ì—…ì¢…
            </Text>
            <TextInput
              value={partnerCategory}
              onChangeText={setPartnerCategory}
              placeholder="ì˜ˆ) ì‹œìˆ (í´ë¦¬ë‹‰) / ìŠ¤í‚¨ì¼€ì–´ / í—¤ì–´ / PT / ë°˜ì˜êµ¬"
              placeholderTextColor="#A3ACBF"
              style={{
                backgroundColor: "#F3F5FA",
                color: PALETTE.text,
                borderRadius: 10,
                paddingHorizontal: 12,
                paddingVertical: 10,
                marginBottom: 10,
              }}
            />
          </>
        )}

        <View
          style={{
            flexDirection: "row",
            alignItems: "center",
            marginBottom: 8,
          }}
        >
          <Switch
            value={consent}
            onValueChange={setConsent}
          />
          <Text
            style={{
              color: PALETTE.text,
              marginLeft: 8,
            }}
          >
            ì „í›„ì‚¬ì§„ ì‚¬ìš©ì— ë™ì˜í•©ë‹ˆë‹¤(ë™ì˜ì„œ ë³´ê´€)
          </Text>
          <TouchableOpacity
            onPress={openTerms}
            style={{ marginLeft: 8 }}
          >
            <Text style={{ color: PALETTE.brand }}>
              ì•½ê´€
            </Text>
          </TouchableOpacity>
        </View>

        <TouchableOpacity
          disabled={!canSubmit}
          onPress={() =>
            onSubmit({
              mode,
              title,
              before: beforeUrl,
              after: afterUrl,
              tags: tags
                .split(" ")
                .filter(Boolean),
              emotion,
              anonymous,
              visibility,
              partnerName,
              partnerCategory,
            })
          }
          style={{
            backgroundColor: canSubmit
              ? PALETTE.brandMint
              : PALETTE.chip,
            paddingVertical: 12,
            borderRadius: 12,
          }}
        >
          <Text
            style={{
              color: "#0A1020",
              fontWeight: "800",
              textAlign: "center",
            }}
          >
            {canSubmit
              ? mode === "user"
                ? "ì¼ë°˜ ì „í›„ ì—…ë¡œë“œ"
                : "ì—…ì²´ ì „í›„ ì—…ë¡œë“œ"
              : "í•„ìˆ˜ ì •ë³´ ì…ë ¥/ë™ì˜"}
          </Text>
        </TouchableOpacity>
      </Card>

      <View style={{ height: 12 }} />
      <UploadGuideCard />
      <View style={{ height: 80 }} />
    </ScrollView>
  );
}

/* ===== íŒŒíŠ¸ë„ˆ / ê°€ì´ë“œ ===== */

function PartnerCard({ p }) {
  const accent = getCategoryBorderColor(p.field);

  return (
    <Card
      style={{ marginBottom: 12 }}
      accent={accent}
    >
      <View
        style={{
          flexDirection: "row",
          justifyContent: "space-between",
          alignItems: "center",
        }}
      >
        <View>
          <Text
            style={{
              color: PALETTE.text,
              fontWeight: "800",
              fontSize: 16,
            }}
          >
            {p.name}
          </Text>
          <Text style={{ color: PALETTE.sub }}>
            {p.field} Â· {p.addr}
          </Text>
        </View>
        <View
          style={{
            backgroundColor: PALETTE.brandMint,
            paddingHorizontal: 10,
            paddingVertical: 6,
            borderRadius: 999,
          }}
        >
          <Text
            style={{
              color: "#0A1020",
              fontWeight: "800",
              fontSize: 12,
            }}
          >
            {p.badge}
          </Text>
        </View>
      </View>

      <View
        style={{
          flexDirection: "row",
          marginTop: 10,
        }}
      >
        <TouchableOpacity
          style={{
            backgroundColor: PALETTE.chip,
            paddingHorizontal: 12,
            paddingVertical: 10,
            borderRadius: 10,
            marginRight: 8,
          }}
        >
          <Text
            style={{
              color: PALETTE.text,
              fontWeight: "800",
            }}
          >
            í”„ë¡œí•„
          </Text>
        </TouchableOpacity>
        <TouchableOpacity
          style={{
            backgroundColor: PALETTE.brand,
            paddingHorizontal: 12,
            paddingVertical: 10,
            borderRadius: 10,
          }}
        >
          <Text
            style={{
              color: "#0A1020",
              fontWeight: "800",
            }}
          >
            ë¬¸ì˜/ì˜ˆì•½
          </Text>
        </TouchableOpacity>
      </View>
    </Card>
  );
}

function PartnerTab() {
  return (
    <ScrollView
      style={{ padding: 12 }}
      showsVerticalScrollIndicator={false}
    >
      <SectionTitle>íŒŒíŠ¸ë„ˆ(ì…ì ì‚¬)</SectionTitle>

      {PARTNERS.map((p) => (
        <PartnerCard key={p.id} p={p} />
      ))}

      <Card>
        <Text
          style={{
            color: PALETTE.sub,
            fontSize: 12,
          }}
        >
          * íŒŒíŠ¸ë„ˆëŠ” ê´€ë¦¬ì ìŠ¹ì¸ í›„ Verified/Pro ë°°ì§€ë¥¼
          ë°›ìŠµë‹ˆë‹¤. ì˜ˆì•½/ê²°ì œ, ë¦¬ë“œ, í†µê³„ ëŒ€ì‹œë³´ë“œëŠ”
          ì°¨ê¸° ìŠ¤í”„ë¦°íŠ¸ì—ì„œ ì—°ê²°.
        </Text>
      </Card>

      <View style={{ height: 80 }} />
    </ScrollView>
  );
}

function GuideTab() {
  return (
    <ScrollView
      style={{ padding: 12 }}
      showsVerticalScrollIndicator={false}
    >
      <SectionTitle>ì´¬ì˜ ê°€ì´ë“œ & í‘œì¤€í™”</SectionTitle>
      <UploadGuideCard />

      <View style={{ height: 12 }} />

      <Card>
        <Text
          style={{
            color: PALETTE.text,
            fontWeight: "800",
            marginBottom: 8,
          }}
        >
          ì „í›„ í‘œì¤€ ë©”íƒ€ë°ì´í„°(ì´ˆì•ˆ)
        </Text>
        <Text
          style={{
            color: PALETTE.sub,
            lineHeight: 20,
          }}
        >
          Â· ì´¬ì˜ì¼ì/ì¥ì†Œ/ì¡°ëª…Â·ë Œì¦ˆ ê³ ì • Â· êµ¬ë„/ê±°ë¦¬/ê°ë„
          ë™ì¼ Â· ì›ë³¸ ìœ ì§€ Â· ë™ì¼ ì¸ë¬¼ í™•ì¸{"\n"}Â· (ì˜ë£Œ)
          ë¡œê·¸ì¸ ì ‘ê·¼ ê¶Œì¥ Â· ë™ì˜ì„œ ë³´ê´€ Â·
          ì‚­ì œ/ë‹¤ìš´ë¡œë“œ ê¶Œë¦¬ ë³´ì¥
        </Text>
      </Card>

      <View style={{ height: 80 }} />
    </ScrollView>
  );
}

/* ===== í† ìŠ¤íŠ¸ ===== */

function Toast({ text, clear }) {
  const opacity = useRef(new Animated.Value(0))
    .current;

  useEffect(() => {
    if (!text) return;

    Animated.sequence([
      Animated.timing(opacity, {
        toValue: 1,
        duration: 150,
        useNativeDriver: true,
      }),
      Animated.delay(1200),
      Animated.timing(opacity, {
        toValue: 0,
        duration: 200,
        useNativeDriver: true,
      }),
    ]).start(() => clear());
  }, [text, opacity, clear]);

  if (!text) return null;

  return (
    <Animated.View
      style={{
        position: "absolute",
        bottom: 120,
        left: 20,
        right: 20,
        opacity,
      }}
    >
      <View
        style={{
          backgroundColor: "rgba(0,0,0,0.8)",
          padding: 12,
          borderRadius: 10,
          borderWidth: 1,
          borderColor: "#2a2f3a",
        }}
      >
        <Text
          style={{
            color: "#fff",
            textAlign: "center",
          }}
        >
          {text}
        </Text>
      </View>
    </Animated.View>
  );
}

/* ===== ë©”ì¸ App ===== */

export default function App() {
  const [tab, setTab] = useState("í”¼ë“œ");
  const [comparePayload, setComparePayload] =
    useState(null);

  // ì‹œìˆ (í´ë¦¬ë‹‰) ê¸°ë³¸ ì„ íƒ
  const [cat, setCat] = useState("ì‹œìˆ (í´ë¦¬ë‹‰)");
  const [q, setQ] = useState("");
  const [sort, setSort] = useState("ì‹ ë¢°ìˆœ");
  const [userFeed, setUserFeed] = useState(
    USER_FEED_SAMPLE
  );
  const [showTerms, setShowTerms] = useState(false);
  const [itemToggles, setItemToggles] = useState({});
  const lastModeRef = useRef("user");

  const [toast, setToast] = useState("");

  const fade = useRef(new Animated.Value(1)).current;

  const changeTab = (next) => {
    Animated.sequence([
      Animated.timing(fade, {
        toValue: 0,
        duration: 120,
        useNativeDriver: true,
      }),
      Animated.timing(fade, {
        toValue: 1,
        duration: 180,
        useNativeDriver: true,
      }),
    ]).start();
    setTab(next);
  };

  const onCompare = (item) => {
    setComparePayload(item);
    changeTab("ë¹„êµ");
  };

  const onSubmitUpload = (payload) => {
    if (payload.mode === "user") {
      const newPost = {
        id: "u-" + Date.now(),
        user: "You",
        desc: payload.emotion || "",
        tags:
          payload.tags && payload.tags.length
            ? payload.tags
            : ["#user", "#upload"],
        before: payload.before,
        after: payload.after,
        likes: 0,
        comments: 0,
        verified: false,
        anonymous: payload.anonymous,
        visibility: payload.visibility,
      };
      setUserFeed([newPost, ...userFeed]);
      setToast("ì—…ë¡œë“œ ì™„ë£Œ! ì»¤ë®¤ë‹ˆí‹°ì— ë°˜ì˜í–ˆì–´.");
      changeTab("ì»¤ë®¤ë‹ˆí‹°");
    } else {
      const demoItem = {
        id: "case-" + Date.now(),
        user: payload.partnerName || "Partner",
        category:
          payload.partnerCategory || "ì‹œìˆ (í´ë¦¬ë‹‰)",
        tags:
          payload.tags && payload.tags.length
            ? payload.tags
            : ["#partner", "#upload"],
        before: payload.before,
        after: payload.after,
        trust: 85,
        partner: payload.partnerName || "ì…ì ì‚¬",
        location: "â€”",
        days: 0,
      };
      setComparePayload(demoItem);
      setToast("ì—…ì²´ ì „í›„ ë¯¸ë¦¬ë³´ê¸°ë¡œ ì´ë™!");
      changeTab("ë¹„êµ");
    }
  };

  return (
    <SafeAreaView
      style={{ flex: 1, backgroundColor: PALETTE.bg }}
    >
      <StatusBar barStyle="dark-content" />
      <Header tab={tab} setTab={changeTab} />

      <Animated.View
        style={{ flex: 1, opacity: fade }}
      >
        {tab === "í”¼ë“œ" && (
          <FeedTab
            onCompare={onCompare}
            cat={cat}
            setCat={setCat}
            q={q}
            setQ={setQ}
            sort={sort}
            setSort={setSort}
            itemToggles={itemToggles}
            setItemToggles={setItemToggles}
          />
        )}
        {tab === "ì»¤ë®¤ë‹ˆí‹°" && (
          <CommunityTab
            userFeed={userFeed}
            setUserFeed={setUserFeed}
            onCompare={onCompare}
            onToast={setToast}
          />
        )}
        {tab === "ì—…ë¡œë“œ" && (
          <UploadTab
            onSubmit={onSubmitUpload}
            openTerms={() => setShowTerms(true)}
            lastModeRef={lastModeRef}
          />
        )}
        {tab === "ë¹„êµ" && (
          <CompareTab payload={comparePayload} />
        )}
        {tab === "íŒŒíŠ¸ë„ˆ" && <PartnerTab />}
        {tab === "ê°€ì´ë“œ" && <GuideTab />}
      </Animated.View>

      <NavBar tab={tab} setTab={changeTab} />

      {/* ì•½ê´€ ëª¨ë‹¬ */}
      <Modal
        visible={showTerms}
        transparent
        animationType="fade"
        onRequestClose={() => setShowTerms(false)}
      >
        <View
          style={{
            flex: 1,
            backgroundColor: "rgba(0,0,0,0.4)",
            justifyContent: "center",
            padding: 20,
          }}
        >
          <View
            style={{
              backgroundColor: PALETTE.card,
              borderRadius: 16,
              borderWidth: 1,
              borderColor: PALETTE.line,
              padding: 16,
            }}
          >
            <Text
              style={{
                color: PALETTE.text,
                fontWeight: "900",
                fontSize: 16,
                marginBottom: 8,
              }}
            >
              ì „í›„ì‚¬ì§„ ì—…ë¡œë“œ ì•½ê´€(ìš”ì•½)
            </Text>
            <Text
              style={{
                color: PALETTE.sub,
                lineHeight: 20,
              }}
            >
              Â· ë³´ì •Â·í•„í„° ì—†ëŠ” ì›ë³¸ ì—…ë¡œë“œë¥¼
              ê¶Œì¥í•©ë‹ˆë‹¤(ììœ  ì—…ë¡œë“œ í—ˆìš©){"\n"}Â· ì—…ë¡œë“œ
              ë™ì˜ ë° ì² íšŒ ê°€ëŠ¥, ì‚­ì œ/ë‹¤ìš´ë¡œë“œ ê¶Œë¦¬
              ë³´ì¥{"\n"}Â· (ì˜ë£Œ) ë¯¼ê°ì •ë³´ í•´ë‹¹ ì‹œ
              ë¡œê·¸ì¸/ê¶Œí•œ ê´€ë¦¬ í•„ìš”{"\n"}Â·
              ë¶ˆë²•/íƒ€ì¸ì •ë³´ ì—…ë¡œë“œ ê¸ˆì§€, ìœ„ë°˜ ì‹œ ì‚­ì œ
            </Text>
            <TouchableOpacity
              onPress={() => setShowTerms(false)}
              style={{
                marginTop: 14,
                backgroundColor: PALETTE.brand,
                paddingVertical: 10,
                borderRadius: 12,
              }}
            >
              <Text
                style={{
                  color: "#0A1020",
                  textAlign: "center",
                  fontWeight: "800",
                }}
              >
                í™•ì¸
              </Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>

      <Toast text={toast} clear={() => setToast("")} />
    </SafeAreaView>
  );
}

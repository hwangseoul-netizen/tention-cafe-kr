import React, { useEffect, useMemo, useRef, useState } from "react";
import {
  View,
  Text,
  Image,
  ScrollView,
  TouchableOpacity,
  SafeAreaView,
  TextInput,
  PanResponder,
  Dimensions,
  Modal,
  StatusBar,
  Switch,
  Animated,
  Easing,
  Platform,
} from "react-native";

/**
 * VISUMOF v1.7 â€” ëª¨ë°”ì¼ ìµœì í™” & í”¼ë“œ ì§‘ì¤‘í˜• UI
 * - ìƒë‹¨ í—¤ë” ì¶•ì†Œ ë° íƒ€ì´í¬ê·¸ë˜í”¼ ë¹„ìœ¨ ì¡°ì •
 * - ì¹´í…Œê³ ë¦¬ í•„í„° ì œê±° (ì¸ìŠ¤íƒ€í˜• ë¬´í•œ í”¼ë“œ)
 * - í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜ ë¹„ìœ¨ ìµœì í™”
 */

const { width: SCREEN_W } = Dimensions.get("window");

const PALETTE = {
  bg: "#FAFAFB",
  card: "#FFFFFF",
  line: "#F1F5F9", // ë” ì—°í•œ ë¼ì¸
  text: "#1F2937", // ì•½ê°„ ë¶€ë“œëŸ¬ìš´ ë¸”ë™
  sub: "#6B7280",
  chip: "#F3F4F6",
  brand: "#FF8FA9",      // ë¸”ëŸ¬ì‰¬ í•‘í¬
  brandMint: "#A7F3D0",  // ë¯¼íŠ¸
  aiAccent: "#A855F7",   // ë” ì„¸ë ¨ëœ AI í¼í”Œ
  danger: "#F87171",
};

const MAIN_TABS = ["ì „í›„ í”¼ë“œ", "íŒŒíŠ¸ë„ˆ", "ì»¤ë®¤ë‹ˆí‹°", "ì—…ë¡œë“œ"];

const MOCK_FEED = [
  {
    id: "ai-001",
    user: "AI Model",
    category: "í—¤ì–´",
    tags: ["#ë ˆì´ì–´ë“œì»·", "#AIê°€ìƒ", "#ìŠ¤íƒ€ì¼ë§"],
    before: "https://images.unsplash.com/photo-1557997977-2f6e7c7038e1?q=80&w=1200",
    after: "https://images.unsplash.com/photo-1596489391038-f947ff9f929d?q=80&w=1200",
    trust: 99,
    partner: "VISUMOF AI Lab",
    location: "Virtual",
    durationDays: 1,
    price: 0,
    isAI: true,
  },
  {
    id: "case-001",
    user: "Jade",
    category: "ì‹œìˆ  í´ë¦¬ë‹‰",
    tags: ["#ì—¬ë“œë¦„í”ì ", "#í†¤ì—…", "#ë¦¬ì–¼í›„ê¸°"],
    before: "https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?q=80&w=1200",
    after: "https://images.unsplash.com/photo-1522335781184-c34e5b39c1b7?q=80&w=1200",
    trust: 92,
    partner: "Glow Clinic",
    location: "Gangnam",
    durationDays: 21,
    price: 380000,
    isAI: false,
  },
  {
    id: "ai-002",
    user: "AI Model",
    category: "í”¼íŠ¸ë‹ˆìŠ¤",
    tags: ["#ë³µê·¼", "#ì²´í˜•êµì •", "#AIì‹œë®¬ë ˆì´ì…˜"],
    before: "https://images.unsplash.com/photo-1526506143619-3354687d7f2a?q=80&w=1200",
    after: "https://images.unsplash.com/photo-1541534741688-6078c6bfb5ab?q=80&w=1200",
    trust: 99,
    partner: "VISUMOF AI Lab",
    location: "Virtual",
    durationDays: 90,
    price: 1500000,
    isAI: true,
  },
    {
    id: "case-003",
    user: "Sol",
    category: "ë°”ë””/ë‹¤ì´ì–´íŠ¸",
    tags: ["#3ì£¼ë³€í™”", "#ì‹ë‹¨ê´€ë¦¬"],
    before: "https://images.unsplash.com/photo-1518611012118-696072aa579a?q=80&w=1200",
    after: "https://images.unsplash.com/photo-1544717305-996b815c338c?q=80&w=1200",
    trust: 90,
    partner: "Core PT Lab",
    location: "Seongsu",
    durationDays: 60,
    price: 550000,
    isAI: false,
  },
   {
    id: "ai-003",
    user: "AI Model",
    category: "ë„¤ì¼ì•„íŠ¸",
    tags: ["#í™”ë ¤í•œë„¤ì¼", "#ì—°ì¥", "#AIë””ìì¸"],
    before: "https://images.unsplash.com/photo-1632498309187-63c8d7634673?q=80&w=1200",
    after: "https://images.unsplash.com/photo-1604654894610-df63bc536371?q=80&w=1200",
    trust: 99,
    partner: "VISUMOF AI Lab",
    location: "Virtual",
    durationDays: 0,
    price: 80000,
    isAI: true,
  },
];

/* ìœ í‹¸ */
function formatDuration(days) {
  if (!days || days <= 0) return "ë‹¹ì¼";
  if (days >= 30) return `${Math.round(days / 30)}ê°œì›”`;
  return `${days}ì¼`;
}

/* --- ì»´í¬ë„ŒíŠ¸ --- */

// 1. ì»´íŒ©íŠ¸í•´ì§„ í—¤ë”
function CompactHeader() {
  const letters = ["V", "I", "S", "U", "M", "O", "F"];
  const colors = ["#FF6B6B", "#FF9F43", "#F6C945", "#1DD1A1", "#48DBFB", "#5F27CD", "#FF6B81"];

  return (
    <View
      style={{
        flexDirection: "row",
        justifyContent: "space-between",
        alignItems: "center",
        paddingHorizontal: 16,
        paddingVertical: 12,
        backgroundColor: "rgba(255,255,255,0.95)",
        borderBottomWidth: 1,
        borderColor: PALETTE.line,
        zIndex: 10,
      }}
    >
      {/* ë¡œê³ : ì‚¬ì´ì¦ˆ ì¶•ì†Œ ë° ìê°„ ì¡°ì • */}
      <View style={{ flexDirection: "row" }}>
        {letters.map((ch, idx) => (
          <Text
            key={idx}
            style={{
              color: colors[idx],
              fontWeight: "900",
              fontSize: 20, // 24 -> 20 ì¶•ì†Œ
              letterSpacing: -0.5, // ìê°„ ì¶•ì†Œ
            }}
          >
            {ch}
          </Text>
        ))}
      </View>

      {/* ìš°ì¸¡ ìŠ¬ë¡œê±´: ì‹¬í”Œí•˜ê²Œ */}
      <View
        style={{
          backgroundColor: "#FFF0F5",
          paddingHorizontal: 10,
          paddingVertical: 4,
          borderRadius: 12,
        }}
      >
        <Text style={{ color: "#BE185D", fontSize: 11, fontWeight: "700" }}>
          Beauty AI Lab
        </Text>
      </View>
    </View>
  );
}

// 2. í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜ (í”Œë¡œíŒ… ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½í•˜ì—¬ ê°œë°©ê° í™•ë³´)
function FloatingNavBar({ tab, setTab }) {
  const icons = {
    "ì „í›„ í”¼ë“œ": "ğŸ”¥",
    "íŒŒíŠ¸ë„ˆ": "ğŸ’",
    "ì»¤ë®¤ë‹ˆí‹°": "ğŸ’¬",
    "ì—…ë¡œë“œ": "ğŸ“·",
  };

  return (
    <View
      style={{
        position: "absolute",
        bottom: 24, // ì¡°ê¸ˆ ë” ë„ì›€
        left: 20,
        right: 20,
        backgroundColor: "#FFFFFF",
        borderRadius: 24,
        flexDirection: "row",
        justifyContent: "space-between",
        paddingVertical: 12,
        paddingHorizontal: 16,
        shadowColor: "#000",
        shadowOpacity: 0.1,
        shadowRadius: 15,
        shadowOffset: { width: 0, height: 8 },
        elevation: 10, // ì•ˆë“œë¡œì´ë“œ ê·¸ë¦¼ì
      }}
    >
      {MAIN_TABS.map((t) => {
        const active = tab === t;
        return (
          <TouchableOpacity
            key={t}
            onPress={() => setTab(t)}
            style={{ alignItems: "center", flex: 1 }}
          >
            <Text style={{ fontSize: 18, marginBottom: 2 }}>{icons[t]}</Text>
            <Text
              style={{
                fontSize: 10,
                fontWeight: active ? "700" : "500",
                color: active ? "#111827" : "#9CA3AF",
              }}
            >
              {t}
            </Text>
          </TouchableOpacity>
        );
      })}
    </View>
  );
}

// 3. AI ë°°ì§€ (ì„¸ë ¨ë˜ê²Œ)
function AIBadge() {
  return (
    <View
      style={{
        flexDirection: "row",
        alignItems: "center",
        backgroundColor: "#F3E8FF", // ì—°í•œ í¼í”Œ
        paddingHorizontal: 8,
        paddingVertical: 4,
        borderRadius: 6,
        borderWidth: 1,
        borderColor: "#E9D5FF",
      }}
    >
      <Text style={{ color: PALETTE.aiAccent, fontWeight: "700", fontSize: 11 }}>
        âœ¨ AI Simulation
      </Text>
    </View>
  );
}

// 4. ì´ë¯¸ì§€ ì»´í¬ë„ŒíŠ¸
function Img({ uri, height = 220 }) {
  return (
    <View
      style={{
        width: "100%",
        height,
        backgroundColor: "#F3F4F6",
        borderRadius: 14,
        overflow: "hidden",
      }}
    >
      <Image
        source={{ uri }}
        style={{ width: "100%", height: "100%", resizeMode: "cover" }}
      />
    </View>
  );
}

// 5. Before/After ìŠ¬ë¼ì´ë” (ëª¨ë‹¬ìš©)
function BeforeAfterSlider({ before, after }) {
  const [width, setWidth] = useState(0);
  const [x, setX] = useState(150);
  
  const pan = useRef(
    PanResponder.create({
      onStartShouldSetPanResponder: () => true,
      onMoveShouldSetPanResponder: () => true,
      onPanResponderMove: (_, g) => {
        // ê°„ë‹¨í•œ êµ¬í˜„: í„°ì¹˜ ìœ„ì¹˜ì— ë”°ë¼ ì´ë™
        // ì‹¤ì œë¡œëŠ” LayoutEventë¡œ widthë¥¼ ë°›ì•„ì•¼ í•¨
         setX(prev => prev + g.dx); 
      },
    })
  ).current;

  return (
    <View 
      onLayout={(e) => setWidth(e.nativeEvent.layout.width)}
      style={{ height: 300, borderRadius: 16, overflow: 'hidden', position: 'relative' }}
    >
        <Image source={{ uri: after }} style={{ width: '100%', height: '100%' }} />
        <View style={{ position: 'absolute', left:0, top:0, bottom:0, width: '50%', overflow:'hidden', borderRightWidth: 2, borderColor: '#fff' }}>
             <Image source={{ uri: before }} style={{ width: width || SCREEN_W, height: 300 }} />
        </View>
        <View style={{position:'absolute', top: 10, left: 10, backgroundColor:'rgba(0,0,0,0.5)', padding:4, borderRadius:4}}>
            <Text style={{color:'#fff', fontSize:10}}>Before</Text>
        </View>
        <View style={{position:'absolute', top: 10, right: 10, backgroundColor:'rgba(0,0,0,0.5)', padding:4, borderRadius:4}}>
            <Text style={{color:'#fff', fontSize:10}}>After</Text>
        </View>
    </View>
  );
}


// 6. í”¼ë“œ ì•„ì´í…œ (ë¹„ìœ¨ ìµœì í™”)
function FeedItem({ item, onPartnerAction, onUserAction }) {
  const isAI = item.isAI;

  return (
    <View
      style={{
        backgroundColor: "#FFFFFF",
        borderRadius: 20,
        marginBottom: 20,
        // ê·¸ë¦¼ì ì œê±°í•˜ê³  ê¹”ë”í•œ ë³´ë”ë¡œ ë³€ê²½ (ì„±ëŠ¥ ë° ëª¨ë˜í•¨)
        borderWidth: 1,
        borderColor: isAI ? "#E9D5FF" : "#F1F5F9",
        padding: 12,
      }}
    >
      {/* í—¤ë”: ìœ ì € ì •ë³´ */}
      <View style={{ flexDirection: "row", alignItems: "center", marginBottom: 10 }}>
        <View
          style={{
            width: 32,
            height: 32,
            borderRadius: 16,
            backgroundColor: isAI ? "#F3E8FF" : "#F3F4F6",
            justifyContent: "center",
            alignItems: "center",
            marginRight: 8,
          }}
        >
          <Text style={{ fontSize: 14 }}>{isAI ? "ğŸ¤–" : item.user[0]}</Text>
        </View>
        <View style={{ flex: 1 }}>
          <Text style={{ fontSize: 14, fontWeight: "700", color: PALETTE.text }}>
            {item.user}
          </Text>
          <Text style={{ fontSize: 11, color: PALETTE.sub }}>
            {item.category}
          </Text>
        </View>
        {isAI && <AIBadge />}
      </View>

      {/* ì´ë¯¸ì§€ (Before/After ì¸ë„¤ì¼ ë¹„êµ) */}
      <View style={{ flexDirection: "row", marginBottom: 10 }}>
        <View style={{ flex: 1, marginRight: 4 }}>
           <Img uri={item.before} height={180} />
           <View style={{position:'absolute', bottom:6, left:6, backgroundColor:'rgba(0,0,0,0.4)', paddingHorizontal:6, borderRadius:4}}>
               <Text style={{color:'#fff', fontSize:10}}>Before</Text>
           </View>
        </View>
        <View style={{ flex: 1, marginLeft: 4 }}>
           <Img uri={item.after} height={180} />
           <View style={{position:'absolute', bottom:6, left:6, backgroundColor:'rgba(0,0,0,0.4)', paddingHorizontal:6, borderRadius:4}}>
               <Text style={{color:'#fff', fontSize:10}}>After</Text>
           </View>
        </View>
      </View>

      {/* íƒœê·¸ ë° ì„¤ëª… */}
      <View style={{ flexDirection: "row", flexWrap: "wrap", marginBottom: 8 }}>
        {item.tags.map((t) => (
          <Text key={t} style={{ color: "#4B5563", fontSize: 12, marginRight: 6 }}>
            {t}
          </Text>
        ))}
      </View>

      {/* ì•¡ì…˜ ë²„íŠ¼ (ë¹„ìœ¨ ì¡°ì •) */}
      {isAI ? (
        <View style={{ flexDirection: "row", gap: 8 }}>
          <TouchableOpacity
            onPress={() => onPartnerAction(item)}
            style={{
              flex: 1,
              backgroundColor: PALETTE.brandMint,
              paddingVertical: 10,
              borderRadius: 12,
              alignItems: "center",
            }}
          >
            <Text style={{ fontSize: 12, fontWeight: "700", color: "#064E3B" }}>
              ğŸ·ï¸ íŒŒíŠ¸ë„ˆ ì…ì 
            </Text>
          </TouchableOpacity>
          <TouchableOpacity
            onPress={() => onUserAction(item)}
            style={{
              flex: 1,
              backgroundColor: "#EFF6FF",
              paddingVertical: 10,
              borderRadius: 12,
              alignItems: "center",
            }}
          >
            <Text style={{ fontSize: 12, fontWeight: "700", color: "#1E40AF" }}>
              ğŸ’– ìƒë‹´ ìš”ì²­
            </Text>
          </TouchableOpacity>
        </View>
      ) : (
        <TouchableOpacity
          style={{
            backgroundColor: "#F3F4F6",
            paddingVertical: 10,
            borderRadius: 12,
            alignItems: "center",
          }}
        >
          <Text style={{ fontSize: 12, fontWeight: "700", color: "#374151" }}>
            ìì„¸íˆ ë³´ê¸°
          </Text>
        </TouchableOpacity>
      )}
    </View>
  );
}

/* --- ë©”ì¸ ì•± --- */
export default function App() {
  const [tab, setTab] = useState("ì „í›„ í”¼ë“œ");
  const [feed] = useState(MOCK_FEED.sort(() => Math.random() - 0.5)); // ëœë¤ ì…”í”Œ
  
  // ìƒíƒœ ê´€ë¦¬ (í† ìŠ¤íŠ¸ ë“±)
  const [toastMsg, setToastMsg] = useState("");
  const fadeAnim = useRef(new Animated.Value(0)).current;

  const showToast = (msg) => {
    setToastMsg(msg);
    Animated.sequence([
      Animated.timing(fadeAnim, { toValue: 1, duration: 200, useNativeDriver: true }),
      Animated.delay(1500),
      Animated.timing(fadeAnim, { toValue: 0, duration: 200, useNativeDriver: true }),
    ]).start();
  };

  return (
    <SafeAreaView style={{ flex: 1, backgroundColor: PALETTE.bg }}>
      <StatusBar barStyle="dark-content" />
      
      {/* 1. ìƒë‹¨ í—¤ë” */}
      <CompactHeader />

      {/* 2. ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */}
      <View style={{ flex: 1 }}>
        {tab === "ì „í›„ í”¼ë“œ" && (
          <ScrollView contentContainerStyle={{ padding: 16, paddingBottom: 100 }}>
            {/* ê²€ìƒ‰ë°” (ì‹¬í”Œí•˜ê²Œ) */}
            <View style={{marginBottom: 16, backgroundColor:'#fff', borderRadius: 12, paddingHorizontal:12, paddingVertical:10, borderWidth:1, borderColor: PALETTE.line, flexDirection:'row', alignItems:'center'}}>
                <Text style={{marginRight:8}}>ğŸ”</Text>
                <TextInput placeholder="ì–´ë–¤ ë³€í™”ë¥¼ ì°¾ìœ¼ì„¸ìš”?" style={{flex:1, fontSize:14}} />
            </View>

            {feed.map((item) => (
              <FeedItem
                key={item.id}
                item={item}
                onPartnerAction={() => showToast("íŒŒíŠ¸ë„ˆ ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!")}
                onUserAction={() => showToast("ìƒë‹´ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!")}
              />
            ))}
          </ScrollView>
        )}
        
        {/* ë‹¤ë¥¸ íƒ­ì€ í”Œë ˆì´ìŠ¤í™€ë” */}
        {tab !== "ì „í›„ í”¼ë“œ" && (
          <View style={{flex:1, justifyContent:'center', alignItems:'center'}}>
              <Text style={{color: PALETTE.sub}}>ì¤€ë¹„ ì¤‘ì¸ í™”ë©´ì…ë‹ˆë‹¤.</Text>
          </View>
        )}
      </View>

      {/* 3. í•˜ë‹¨ í”Œë¡œíŒ… ë‚´ë¹„ê²Œì´ì…˜ */}
      <FloatingNavBar tab={tab} setTab={setTab} />

      {/* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */}
      <Animated.View
        style={{
          position: "absolute",
          top: 100,
          alignSelf: "center",
          backgroundColor: "rgba(0,0,0,0.8)",
          paddingHorizontal: 20,
          paddingVertical: 10,
          borderRadius: 20,
          opacity: fadeAnim,
        }}
      >
        <Text style={{ color: "#fff", fontWeight: "600", fontSize: 13 }}>{toastMsg}</Text>
      </Animated.View>
    </SafeAreaView>
  );
}
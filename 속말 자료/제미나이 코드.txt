import React, { useState, useEffect, useRef } from 'react';
import { 
  Text, View, StyleSheet, ScrollView, TouchableOpacity, Image, StatusBar, 
  SafeAreaView, Dimensions, Modal, TextInput, Alert, FlatList, 
  KeyboardAvoidingView, Platform, Animated, Easing, RefreshControl, Keyboard, TouchableWithoutFeedback 
} from 'react-native';

// --- ğŸ¤– AI ë´‡ ë° ëœë¤ ë°© ì œëª© ë°ì´í„° ---
const RANDOM_TITLES = [
  "âš¡ ê¸‰ë²™! ì§€ê¸ˆ ë‹¹ì¥ í™ëŒ€ ì˜¤ì‹¤ ë¶„?",
  "âš¡ ì•¼ì‹ìœ¼ë¡œ ì¹˜í‚¨ vs í”¼ì íˆ¬í‘œ ì¢€",
  "âš¡ ì  ì•ˆ ì™€ì„œ ì¼œë´¤ìŒ (ë…¸ë˜ ë¶ˆëŸ¬ë“œë¦¼)",
  "âš¡ ì „ë‚¨ì¹œí•œí…Œ ë¶€ì¬ì¤‘ ì™€ìˆëŠ”ë°.. í•˜",
  "âš¡ ë¹„íŠ¸ì½”ì¸ ë–¡ë½ ì¤‘... í•œê°•ë¬¼ ë”°ëœ»í•˜ëƒ",
  "âš¡ ë¡¤(LoL) ì¹¼ë°”ëŒ ë‚˜ë½ 5ì¸í êµ¬í•¨",
  "âš¡ ë°¸ëŸ°ìŠ¤ ê²Œì„: í‰ìƒ ë‘í†µ vs í‰ìƒ ì¹˜í†µ",
  "âš¡ íšŒì‚¬ ë•Œë ¤ì¹˜ìš°ê³  ì‹¶ì„ ë•Œ ë“¤ì–´ì˜¤ì…ˆ",
  "âš¡ ë„·í”Œë¦­ìŠ¤ ì˜í™” ì¶”ì²œë°›ìŠµë‹ˆë‹¤ (ê³µí¬ X)",
  "âš¡ ê·¸ëƒ¥ ì•„ë¬´ ë§ì´ë‚˜ í•˜ëŠ” ë°©"
];

const BOT_SCRIPTS = {
  FINANCE: ["ì´ì•¼... ì°¨íŠ¸ ì‚´ë²Œí•˜ë„¤", "êµ¬ì¡°ëŒ€ ì–¸ì œ ì˜¤ë‚˜ìš”?", "ì§€ê¸ˆ ì‚¬ë©´ í‘ìš°ì¸ê°€ìš”?", "ì¡´ë²„ëŠ” ìŠ¹ë¦¬í•œë‹¤..!", "í•œê°•ë·° ê°€ì¦ˆì•„"],
  LOVE: ["ê·¸ê±´ 100% ê·¸ë¦°ë¼ì´íŠ¸ì„", "í—¤ì–´ì§€ì„¸ìš” ê·¸ê²Œ ë‹µì…ë‹ˆë‹¤", "í¬ë¦¬ìŠ¤ë§ˆìŠ¤ì— ë­í•˜ì§€..", "ì—°ë½í•˜ì§€ ë§ˆì„¸ìš” ì œë°œ", "ì„¤ë Œë‹¤.."],
  DEFAULT: ["ë°˜ê°‘ìŠµë‹ˆë‹¤~", "ëª©ì†Œë¦¬ ì¢‹ìœ¼ì‹œë„¤ìš”", "ë°©ì¥ë‹˜ ë…¸ë˜ í•œ ê³¡?", "ì—¬ê¸° ë¶„ìœ„ê¸° ë§›ì§‘ì´ë„¤", "ã…‹ã…‹ã…‹ã…‹ã…‹ã…‹"]
};

// --- ì´ˆê¸° ë°© ë°ì´í„° ---
const INITIAL_ROOMS = [
  { id: 1, title: "ğŸ“‰ ë¹„íŠ¸ì½”ì¸ -5%.. ë¹„ìƒëŒ€ì±…ìœ„ì›íšŒ", tension: 9.9, speakers: 24, listeners: 1250, category: "FINANCE", host: "https://api.dicebear.com/7.x/avataaars/png?seed=Felix" },
  { id: 2, title: "ğŸ’” ì „ ì• ì¸ ì—°ë½.. ë°›ëŠ”ë‹¤ vs ì•ˆë°›ëŠ”ë‹¤", tension: 5.8, speakers: 4, listeners: 33, category: "LOVE", host: "https://api.dicebear.com/7.x/avataaars/png?seed=Love" },
  { id: 3, title: "ğŸ¤¬ ì§ì¥ ìƒì‚¬ ë’·ë‹´í™” (ìš•ì„¤ê°€ëŠ¥)", tension: 8.8, speakers: 6, listeners: 42, category: "ANGRY", host: "https://api.dicebear.com/7.x/avataaars/png?seed=Angry" },
  { id: 4, title: "ğŸ‘» ì‹¤ì‹œê°„ ê³µí¬ì° (BGM ìˆìŒ)", tension: 6.2, speakers: 2, listeners: 89, category: "HORROR", host: "https://api.dicebear.com/7.x/avataaars/png?seed=Ghost" },
];

const INITIAL_CHATS = [
  { id: 1, user: 'System', text: 'ğŸ”¥ ëœ¨ê±°ìš´ í† ë¡ ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤!', isSystem: true },
];

export default function App() {
  const [currentRoom, setCurrentRoom] = useState(null);
  const [rooms, setRooms] = useState(INITIAL_ROOMS);
  const [myProfile, setMyProfile] = useState({ name: "ë‚˜ê·¸ë„¤", seed: "Me", points: 1000 });
  
  // í…Œë§ˆ ë¡œì§
  const getTheme = (score) => {
    if (score >= 8.5) return { bg: '#2a0a0a', light: '#FF5252', badge: 'HOT', bubble: '#FF5252' };
    if (score >= 6.0) return { bg: '#2a1a0a', light: '#FF9800', badge: 'ACTIVE', bubble: '#FF9800' };
    if (score >= 3.5) return { bg: '#1a0a2a', light: '#E040FB', badge: 'TALK', bubble: '#E040FB' };
    return { bg: '#0a112a', light: '#448AFF', badge: 'CALM', bubble: '#448AFF' };
  };

  const getTensionMessage = (score) => {
    if (score < 3) return "ğŸ¤« ì†Œê·¼ì†Œê·¼.. ì‰¿! ì¡°ìš©íˆ ë§í•´ìš”";
    if (score < 6) return "â˜• ì ë‹¹í•œ í…ì…˜, í¸ì•ˆí•œ ìˆ˜ë‹¤ íƒ€ì„";
    if (score < 9) return "ğŸ—£ï¸ ì‹œëŒë²…ì ! ëª©ì†Œë¦¬ ì¢€ ë†’ì—¬ë³¼ê¹Œìš”?";
    return "ğŸ”¥ í…ì…˜ í­ë°œ! ê³ ë§‰ ì£¼ì˜! ê´‘ë€ì˜ íŒŒí‹°!";
  };

  // --- ì»´í¬ë„ŒíŠ¸: ë‚©ì‘ ìŠ¬ë¼ì´ë” ---
  const FlatTensionSlider = ({ tension, setTension, theme }) => {
    const handleTouch = (e) => {
      const { locationX } = e.nativeEvent;
      const trackWidth = Dimensions.get('window').width - 40; 
      let newScore = (locationX / trackWidth) * 10;
      if (newScore < 0) newScore = 0; if (newScore > 10) newScore = 10;
      setTension(parseFloat(newScore.toFixed(1)));
    };
    return (
      <View style={[styles.flatBox, { borderColor: theme.light }]}>
        <View style={styles.flatHeader}>
          <Text style={[styles.flatLabel, { color: theme.light }]}>TENSION SETTING</Text>
          <Text style={[styles.flatValue, { color: theme.light }]}>{tension}</Text>
        </View>
        <View style={styles.touchArea} onTouchStart={handleTouch} onTouchMove={handleTouch}>
          <View style={styles.sliderTrack}>
              <View style={[styles.sliderFill, { width: `${tension * 10}%`, backgroundColor: theme.light }]} />
              <View style={[styles.sliderThumb, { left: `${tension * 10}%` }]} />
          </View>
        </View>
        <Text style={styles.flatDesc}>{getTensionMessage(tension)}</Text>
      </View>
    );
  };

  // --- ì»´í¬ë„ŒíŠ¸: íŒŒë™ ì• ë‹ˆë©”ì´ì…˜ ---
  const PulseAvatar = ({ uri, color }) => {
    const scaleAnim = useRef(new Animated.Value(1)).current;
    const opacityAnim = useRef(new Animated.Value(0.5)).current;
    useEffect(() => {
      Animated.loop(
        Animated.parallel([
          Animated.timing(scaleAnim, { toValue: 1.6, duration: 1500, easing: Easing.out(Easing.ease), useNativeDriver: true }),
          Animated.timing(opacityAnim, { toValue: 0, duration: 1500, easing: Easing.out(Easing.ease), useNativeDriver: true })
        ])
      ).start();
    }, []);
    return (
      <View style={{ alignItems: 'center', justifyContent: 'center', width: 60, height: 60 }}>
        <Animated.View style={{position: 'absolute', width: 40, height: 40, borderRadius: 20, backgroundColor: color, transform: [{ scale: scaleAnim }], opacity: opacityAnim}} />
        <Image source={{ uri }} style={{ width: 40, height: 40, borderRadius: 20, borderWidth: 2, borderColor: 'white', zIndex:1 }} />
      </View>
    );
  };

  // --- í™”ë©´ 1: ë¡œë¹„ ---
  const Lobby = () => {
    const [myTension, setMyTension] = useState(5.0);
    const theme = getTheme(myTension);
    const [isCreateModal, setCreateModal] = useState(false);
    const [isProfileModal, setProfileModal] = useState(false);
    const [newTitle, setNewTitle] = useState('');
    const [newCat, setNewCat] = useState('CHAT');
    const [filterMode, setFilterMode] = useState('DEFAULT'); // í•„í„° ìƒíƒœ í‘œì‹œìš©

    // âš¡ [í•µì‹¬ ê¸°ëŠ¥] ë²ˆê°œ ë²„íŠ¼: ëœë¤ ë°© 5ê°œ ì¦‰ì‹œ ìƒì„±
    const generateRandomRooms = () => {
      const newRandomRooms = Array.from({ length: 5 }).map((_, i) => {
        const randomTitle = RANDOM_TITLES[Math.floor(Math.random() * RANDOM_TITLES.length)];
        const randomTension = parseFloat((Math.random() * 10).toFixed(1));
        return {
          id: Date.now() + i,
          title: randomTitle,
          tension: randomTension,
          speakers: Math.floor(Math.random() * 10),
          listeners: Math.floor(Math.random() * 100),
          category: "RANDOM",
          host: `https://api.dicebear.com/7.x/avataaars/png?seed=${Math.random()}`
        };
      });
      // ê¸°ì¡´ ëª©ë¡ ë§¨ ìœ„ì— ì¶”ê°€
      setRooms(prev => [...newRandomRooms, ...prev]);
      Alert.alert("âš¡ ë²ˆê°œ ì†Œì§‘ ì™„ë£Œ!", "ìƒˆë¡œìš´ ëœë¤ ëŒ€í™”ë°© 5ê°œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
    };

    // ğŸ” [í•µì‹¬ ê¸°ëŠ¥] í•„í„°: ì·¨ì†Œ ì—†ì´ 3ê°€ì§€ ì˜µì…˜ë§Œ
    const handleFilter = () => {
      Alert.alert(
        "í•„í„° ì„¤ì •",
        "ì›í•˜ëŠ” ì •ë ¬ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”",
        [
          { text: "ğŸ”„ ì´ˆê¸°í™”", onPress: () => { setRooms(INITIAL_ROOMS); setFilterMode('DEFAULT'); } },
          { text: "ğŸ‘¥ ì¸ì›ìˆœ", onPress: () => { 
              const sorted = [...rooms].sort((a, b) => b.listeners - a.listeners); 
              setRooms(sorted); 
              setFilterMode('PEOPLE');
            } 
          },
          { text: "ğŸ”¥ í…ì…˜ìˆœ", onPress: () => { 
              const sorted = [...rooms].sort((a, b) => b.tension - a.tension); 
              setRooms(sorted); 
              setFilterMode('TENSION');
            } 
          },
        ]
      );
    };

    // â• [í•µì‹¬ ê¸°ëŠ¥] ì‚¬ìš©ì ìˆ˜ë™ ë°© ë§Œë“¤ê¸°
    const createRoom = () => {
      if(!newTitle.trim()) return;
      const newRoom = { id: Date.now(), title: newTitle, tension: 5.0, speakers: 1, listeners: 0, category: newCat, host: `https://api.dicebear.com/7.x/avataaars/png?seed=${myProfile.seed}` };
      setRooms([newRoom, ...rooms]);
      setCreateModal(false); setNewTitle('');
      setCurrentRoom(newRoom);
    };

    return (
      <SafeAreaView style={[styles.container, { backgroundColor: theme.bg }]}>
        <StatusBar barStyle="light-content" />
        <View style={styles.header}>
          <View>
            <Text style={styles.headerTitle}>SOK-MAL</Text>
            <Text style={styles.headerSubtitle}>by TENtion</Text> 
          </View>
          <TouchableOpacity onPress={() => setProfileModal(true)} style={styles.pointsBadge}>
            <Text style={{color:'#FFD700', fontWeight:'bold', marginRight:5, fontSize:12}}>ğŸ’ {myProfile.points}</Text>
            <Image source={{ uri: `https://api.dicebear.com/7.x/avataaars/png?seed=${myProfile.seed}` }} style={{width:24, height:24, borderRadius:12}} />
          </TouchableOpacity>
        </View>

        <View style={styles.contentPadding}>
          <View style={{ marginBottom: 20 }}>
            <FlatTensionSlider tension={myTension} setTension={setMyTension} theme={theme} />
          </View>

          {/* ë¦¬ìŠ¤íŠ¸ í—¤ë”: ë²ˆê°œ ë²„íŠ¼ & í•„í„° ë²„íŠ¼ ë°°ì¹˜ */}
          <View style={styles.listHeader}>
             <Text style={styles.sectionTitle}>NOW LIVE ({rooms.length})</Text>
             <View style={{flexDirection:'row', alignItems:'center'}}>
               {/* âš¡ í•„í„° ì˜† ë²ˆê°œ ë²„íŠ¼ */}
               <TouchableOpacity onPress={generateRandomRooms} style={{marginRight: 15, backgroundColor:'rgba(255,255,0,0.2)', padding:5, borderRadius:8}}>
                 <Text style={{fontSize:16}}>âš¡ ëœë¤ìƒì„±</Text>
               </TouchableOpacity>
               
               {/* ğŸ” í•„í„° ë²„íŠ¼ */}
               <TouchableOpacity onPress={handleFilter}>
                 <Text style={{color: filterMode==='DEFAULT'?'#aaa':'white', fontWeight:'bold'}}>
                   {filterMode === 'TENSION' ? 'ğŸ”¥ í…ì…˜ìˆœ' : filterMode === 'PEOPLE' ? 'ğŸ‘¥ ì¸ì›ìˆœ' : 'Filter â–¾'}
                 </Text>
               </TouchableOpacity>
             </View>
          </View>

          <ScrollView showsVerticalScrollIndicator={false} contentContainerStyle={{paddingBottom: 80}}>
            {rooms.map((room) => {
              const rTheme = getTheme(room.tension);
              return (
                <TouchableOpacity key={room.id} activeOpacity={0.9} style={[styles.card, { borderColor: rTheme.light }]} onPress={() => setCurrentRoom(room)}>
                    <View style={styles.cardHeader}>
                      <View style={[styles.badge, { borderColor: rTheme.light }]}><Text style={{color:rTheme.light, fontSize:9, fontWeight:'bold'}}>{room.category}</Text></View>
                      <Text style={{color:rTheme.light, fontWeight:'900', fontSize:14}}>{room.tension}</Text>
                    </View>
                    <Text style={styles.roomTitle} numberOfLines={2}>{room.title}</Text>
                    <Text style={{color:'#888', fontSize:11, marginTop:10}}>ğŸ¤ {room.speakers}  ğŸ§ {room.listeners}</Text>
                </TouchableOpacity>
              );
            })}
          </ScrollView>
        </View>

        {/* â• í•˜ë‹¨ í”ŒëŸ¬ìŠ¤ ë²„íŠ¼ (ìˆ˜ë™ ìƒì„±) */}
        <TouchableOpacity style={styles.fab} onPress={() => setCreateModal(true)}>
          <Text style={{fontSize: 30, color:'black', marginTop:-2}}>+</Text>
        </TouchableOpacity>

        {/* ë°© ë§Œë“¤ê¸° ëª¨ë‹¬ */}
        <Modal visible={isCreateModal} transparent animationType="slide">
          <KeyboardAvoidingView behavior={Platform.OS === 'ios' ? 'padding' : 'height'} style={styles.modalOverlay}>
            <View style={styles.modalBox}>
              <Text style={styles.modalTitle}>ëŒ€í™”ë°© ê°œì„¤</Text>
              <TextInput style={styles.input} placeholder="ë°© ì œëª© ì…ë ¥" placeholderTextColor="#666" value={newTitle} onChangeText={setNewTitle} />
              <View style={{flexDirection:'row', gap:10, marginBottom:20}}>
                {['CHAT','LOVE','GAME'].map(c=>(
                  <TouchableOpacity key={c} onPress={()=>setNewCat(c)} style={[styles.catBtn, newCat===c && {backgroundColor:'white'}]}>
                    <Text style={{color: newCat===c?'black':'#888', fontWeight:'bold'}}>{c}</Text>
                  </TouchableOpacity>
                ))}
              </View>
              <View style={{flexDirection:'row', gap:10}}>
                <TouchableOpacity style={[styles.modalBtn, {backgroundColor:'#333'}]} onPress={()=>setCreateModal(false)}><Text style={{color:'white'}}>ì·¨ì†Œ</Text></TouchableOpacity>
                <TouchableOpacity style={[styles.modalBtn, {backgroundColor:'white'}]} onPress={createRoom}><Text style={{color:'black', fontWeight:'bold'}}>ë§Œë“¤ê¸°</Text></TouchableOpacity>
              </View>
            </View>
          </KeyboardAvoidingView>
        </Modal>

        {/* í”„ë¡œí•„ ëª¨ë‹¬ */}
        <Modal visible={isProfileModal} transparent animationType="fade">
          <TouchableOpacity activeOpacity={1} onPress={() => Keyboard.dismiss()} style={styles.modalOverlay}>
            <TouchableWithoutFeedback>
              <View style={styles.modalBox}>
                <Text style={styles.modalTitle}>MY PROFILE</Text>
                <View style={{alignItems:'center', marginBottom:20}}>
                  <Image source={{ uri: `https://api.dicebear.com/7.x/avataaars/png?seed=${myProfile.seed}` }} style={{width:80, height:80, borderRadius:40, borderWidth:2, borderColor:'white', marginBottom:10}} />
                  <TextInput style={styles.profileInput} value={myProfile.name} onChangeText={(t)=>setMyProfile({...myProfile, name:t})} placeholder="ë‹‰ë„¤ì„ ì…ë ¥" placeholderTextColor="#999" />
                </View>
                <Text style={{color:'#FFD700', textAlign:'center', fontSize:20, fontWeight:'bold', marginBottom:20}}>ğŸ’ {myProfile.points.toLocaleString()} Point</Text>
                <TouchableOpacity style={[styles.modalBtn, {backgroundColor:'white'}]} onPress={()=>setProfileModal(false)}><Text style={{fontWeight:'bold'}}>ì €ì¥</Text></TouchableOpacity>
              </View>
            </TouchableWithoutFeedback>
          </TouchableOpacity>
        </Modal>
      </SafeAreaView>
    );
  };

  // --- í™”ë©´ 2: ë°© ìƒì„¸ ---
  const RoomDetail = ({ room, onBack }) => {
    const [roomTension, setRoomTension] = useState(room.tension);
    const theme = getTheme(roomTension);
    const [chatMsg, setChatMsg] = useState('');
    const [chats, setChats] = useState(INITIAL_CHATS);
    const [voiceMode, setVoiceMode] = useState('NORMAL'); 
    const flatListRef = useRef();

    // AI ìë™ ëŒ€í™”
    useEffect(() => {
      const interval = setInterval(() => {
        const scripts = BOT_SCRIPTS[room.category] || BOT_SCRIPTS['DEFAULT'];
        const randomMsg = scripts[Math.floor(Math.random() * scripts.length)];
        const botChat = { id: Date.now(), user: "User" + Math.floor(Math.random() * 100), text: randomMsg, isMe: false, isSystem: false };
        setChats(prev => [...prev, botChat]);
      }, 3500); 
      return () => clearInterval(interval);
    }, [room]);

    const sendChat = () => {
      if(!chatMsg.trim()) return;
      const newChat = { id: Date.now(), user: "ë‚˜", text: chatMsg, isMe: true };
      setChats([...chats, newChat]);
      setChatMsg('');
    };

    const sendGift = () => {
      Alert.alert("ğŸ’ ë³„í’ì„  ì˜ê¸°", "100í¬ì¸íŠ¸ë¥¼ ì„ ë¬¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [
        { text: "ì·¨ì†Œ" },
        { text: "ì˜ê¸°!", onPress: () => {
           setChats(prev => [...prev, { id: Date.now(), text: `ğŸ’ ë‹˜ì´ ë³„í’ì„  100ê°œë¥¼ ì„ ë¬¼í–ˆìŠµë‹ˆë‹¤!`, isSystem: true }]);
        }}
      ]);
    };

    return (
      <SafeAreaView style={[styles.container, { backgroundColor: theme.bg }]}>
        <KeyboardAvoidingView behavior={Platform.OS === "ios" ? "padding" : "height"} style={{flex:1}}>
          <View style={styles.roomHeader}>
            <TouchableOpacity onPress={onBack}><Text style={{color:'white', fontSize:18, fontWeight:'bold'}}>â€¹ Back</Text></TouchableOpacity>
            <View style={{alignItems:'center'}}>
               <Text style={{color:'white', fontWeight:'bold'}}>{room.title}</Text>
               <Text style={{color:theme.light, fontSize:10}}>Tension {roomTension} â€¢ {voiceMode} ëª¨ë“œ</Text>
            </View>
            <View style={{width:40}}></View>
          </View>

          <View style={{flex:1}}>
            <View style={{paddingHorizontal:20, marginBottom:10}}>
              {/* ëª©ì†Œë¦¬ ë³€ì¡° ë²„íŠ¼ */}
              <View style={styles.voiceControl}>
                {['NORMAL', 'HELIUM', 'CAVE', 'ROBOT'].map(mode => (
                  <TouchableOpacity key={mode} onPress={()=>setVoiceMode(mode)} style={[styles.voiceBtn, voiceMode===mode && {backgroundColor:theme.light, borderColor:theme.light}]}>
                    <Text style={[styles.voiceText, voiceMode===mode && {color:'black'}]}>{mode}</Text>
                  </TouchableOpacity>
                ))}
              </View>

              <View style={styles.topicCard}>
                <View style={styles.speakerRow}>
                  <PulseAvatar uri={room.host} color={theme.light} />
                  <View style={{marginLeft:10}}>
                     <Text style={{color:'white', fontWeight:'bold'}}>HOST</Text>
                     <Text style={{color:theme.light, fontSize:12}}>ë§í•˜ëŠ” ì¤‘...</Text>
                  </View>
                </View>
              </View>
            </View>

            <View style={styles.chatContainer}>
              <FlatList
                ref={flatListRef}
                data={chats}
                keyExtractor={item => item.id.toString()}
                onContentSizeChange={()=> flatListRef.current?.scrollToEnd({animated: true})}
                renderItem={({item}) => {
                  if(item.isSystem) return <View style={styles.sysMsg}><Text style={styles.sysText}>{item.text}</Text></View>;
                  return (
                    <View style={[styles.chatBubble, item.isMe ? {alignSelf:'flex-end', backgroundColor:theme.bubble} : {alignSelf:'flex-start', backgroundColor:'#333'}]}>
                      {!item.isMe && <Text style={styles.chatUser}>{item.user}</Text>}
                      <Text style={{color:'white', fontSize:14}}>{item.text}</Text>
                    </View>
                  );
                }}
                contentContainerStyle={{padding:20}}
              />
            </View>
          </View>

          <View style={styles.inputArea}>
            <TouchableOpacity onPress={sendGift} style={{marginRight:10}}><Text style={{fontSize:24}}>ğŸ’</Text></TouchableOpacity>
            <TextInput 
              style={styles.chatInput} 
              placeholder="ëŒ€í™” ì°¸ì—¬..." 
              placeholderTextColor="#888"
              value={chatMsg}
              onChangeText={setChatMsg}
              onSubmitEditing={sendChat}
            />
            <TouchableOpacity onPress={sendChat} style={[styles.sendBtn, {backgroundColor:theme.light}]}>
               <Text style={{fontWeight:'bold'}}>â¬†</Text>
            </TouchableOpacity>
          </View>
        </KeyboardAvoidingView>
      </SafeAreaView>
    );
  };

  return currentRoom ? <RoomDetail room={currentRoom} onBack={() => setCurrentRoom(null)} /> : <Lobby />;
}

// --- ìŠ¤íƒ€ì¼ ---
const styles = StyleSheet.create({
  container: { flex: 1, paddingTop: 10 },
  header: { flexDirection: 'row', justifyContent: 'space-between', paddingHorizontal: 20, paddingVertical: 15, alignItems: 'center' },
  headerTitle: { fontSize: 24, fontWeight: '900', color: 'white', fontStyle: 'italic' },
  headerSubtitle: { fontSize: 10, color: '#aaa', marginTop: 2 }, 
  pointsBadge: {flexDirection:'row', alignItems:'center', backgroundColor:'rgba(255,255,255,0.1)', paddingHorizontal:10, paddingVertical:5, borderRadius:20},
  contentPadding: { paddingHorizontal: 20, flex: 1 },

  flatBox: { backgroundColor: 'rgba(0,0,0,0.5)', borderRadius: 16, paddingVertical: 15, paddingHorizontal: 20, borderWidth: 1 },
  flatHeader: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 },
  flatLabel: { fontSize: 11, fontWeight: 'bold', letterSpacing: 1.5, opacity: 0.9 },
  flatValue: { fontSize: 20, fontWeight: '900', fontStyle: 'italic' },
  flatDesc: { color: '#ddd', fontSize: 12, marginTop: 10, textAlign: 'center', fontWeight: '500', opacity: 0.8 },
  touchArea: { width: '100%', height: 30, justifyContent: 'center' },
  sliderTrack: { width: '100%', height: 6, backgroundColor: 'rgba(255,255,255,0.15)', borderRadius: 3 },
  sliderFill: { height: '100%', borderRadius: 3 },
  sliderThumb: { position: 'absolute', top: -7, width: 20, height: 20, backgroundColor: 'white', borderRadius: 10, marginLeft: -10, borderWidth:2, borderColor:'#000' },

  listHeader: { flexDirection:'row', justifyContent:'space-between', alignItems:'center', marginBottom:12 },
  sectionTitle: { color: 'white', fontSize: 16, fontWeight: 'bold' },
  card: { marginBottom: 12, borderRadius: 18, padding: 18, borderWidth: 1, backgroundColor: 'rgba(0,0,0,0.3)' },
  cardHeader: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 8 },
  badge: { paddingHorizontal: 8, paddingVertical: 3, borderRadius: 6, borderWidth: 1 },
  roomTitle: { fontSize: 16, fontWeight: 'bold', color: 'white', lineHeight: 22 },

  // ìš°ì¸¡ í•˜ë‹¨ í”ŒëŸ¬ìŠ¤ ë²„íŠ¼
  fab: { position: 'absolute', bottom: 30, right: 20, width: 60, height: 60, borderRadius: 30, backgroundColor: 'white', justifyContent: 'center', alignItems: 'center', elevation: 8, shadowColor:'#000', shadowOpacity:0.5, shadowRadius:10, zIndex: 999 },

  roomHeader: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', padding: 20 },
  topicCard: { backgroundColor: 'rgba(255,255,255,0.05)', padding: 15, borderRadius: 20, marginTop: 10, flexDirection:'row', alignItems:'center' },
  speakerRow: { flexDirection: 'row', alignItems: 'center' },

  voiceControl: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 10 },
  voiceBtn: { paddingVertical: 6, paddingHorizontal: 10, borderRadius: 15, borderWidth: 1, borderColor: '#444' },
  voiceText: { color: '#888', fontSize: 10, fontWeight: 'bold' },

  chatContainer: { flex: 1, backgroundColor: 'rgba(0,0,0,0.2)', borderTopLeftRadius: 30, borderTopRightRadius: 30 },
  chatBubble: { padding: 12, borderRadius: 16, marginBottom: 10, maxWidth: '80%' },
  chatUser: { color: '#ccc', fontSize: 10, marginBottom: 2, fontWeight:'bold' },
  sysMsg: { alignSelf: 'center', backgroundColor: 'rgba(255,215,0,0.2)', paddingHorizontal: 15, paddingVertical: 5, borderRadius: 15, marginBottom: 10 },
  sysText: { color: '#FFD700', fontSize: 12, fontWeight: 'bold' },

  inputArea: { flexDirection: 'row', padding: 15, backgroundColor: '#111', alignItems:'center' },
  chatInput: { flex: 1, backgroundColor: '#333', color: 'white', borderRadius: 20, paddingHorizontal: 15, height: 40, marginRight: 10 },
  sendBtn: { width: 40, height: 40, borderRadius: 20, justifyContent: 'center', alignItems: 'center' },

  modalOverlay: { flex: 1, backgroundColor: 'rgba(0,0,0,0.8)', justifyContent: 'center', alignItems: 'center' },
  modalBox: { width: 300, backgroundColor: '#1A1A1A', borderRadius: 24, padding: 25, borderWidth: 1, borderColor: '#333' },
  modalTitle: { color: 'white', fontSize: 18, fontWeight: 'bold', marginBottom: 20, textAlign: 'center' },
  input: { backgroundColor: '#333', color: 'white', borderRadius: 12, padding: 15, marginBottom: 20 },
  profileInput: { width: '90%', height: 50, backgroundColor: 'white', borderRadius: 12, color: 'black', fontSize: 18, fontWeight: 'bold', textAlign: 'center', paddingHorizontal: 10 },
  catBtn: { padding: 10, borderRadius: 8, borderWidth: 1, borderColor: '#444' },
  modalBtn: { flex: 1, padding: 15, borderRadius: 12, alignItems: 'center' }
});